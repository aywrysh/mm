<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>إيداعات (مبسّط)</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --accent:#BBCF38; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --bg:#f7f8fa; --card:#fff; --top:56px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Cairo",system-ui,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}

    /* شريط علوي */
    .topbar{
      position:fixed; inset-inline:0; top:0; height:var(--top); background:var(--card);
      border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; padding:0 12px; z-index:10;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:12px;height:12px;border-radius:50%;background:var(--accent)}
    .btn{display:grid;place-items:center;width:40px;height:40px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .ms{font-family:'Material Symbols Rounded'}

    /* المحتوى */
    .wrap{padding:calc(var(--top) + 14px) 10px 16px; max-width:1100px; margin:0 auto}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px}

    /* القائمة الخطّية */
    .list{
      display:grid; gap:6px;
      overflow-x:auto;                 /* NEW: تمكين السحب الأفقي */
      -webkit-overflow-scrolling:touch;/* NEW: سحب ناعم على الجوال */
      padding-bottom:4px;              /* NEW: مساحة صغيرة تحت للسكرول */
    }
    .row{
      display:flex; align-items:center; gap:8px; padding:8px 10px;
      border:1px solid var(--line); border-radius:10px; background:#fff;
      font-weight:700; font-size:14px; white-space:nowrap;
      /* كان هنا overflow:hidden; text-overflow:ellipsis وتمت إزالتهما */
      width:max-content;               /* NEW: عرض السطر = عرض المحتوى */
      min-width:680px;                 /* NEW: أقل عرض للسطر (عدّل لو حبيت) */
    }
    .name{max-width:26ch; overflow:hidden; text-overflow:ellipsis}
    .sep{opacity:.5}
    .amt{font-weight:900}
    .time{color:var(--muted); font-weight:700}
    .idtxt{direction:ltr}

    /* شريط أدوات بسيط */
    .tools{display:flex; gap:8px; align-items:center; margin:0 0 10px}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; font-weight:800; font-size:12px}
    .live-ok{background:#f0fdf4; border-color:#dcfce7}
    .live-bad{background:#fff1f1; border-color:#ffe4e6}

    /* توست */
    .toast{
      position:fixed; bottom:18px; left:50%; transform:translateX(-50%) scale(.96);
      background:rgba(17,17,17,.92); color:#fff; padding:8px 12px; border-radius:10px; font-weight:800; font-size:12px;
      opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:30;
    }
    .toast.show{opacity:1; transform:translateX(-50%) scale(1)}

    /* فراغ */
    .empty{padding:14px; text-align:center; color:var(--muted); border:1px dashed var(--line); border-radius:10px}

    /* أزرار العمليات داخل كل سطر */
    .ops{margin-inline-start:auto; display:flex; gap:6px}
    .op{
      padding:5px 8px; border:1px solid var(--line); border-radius:8px;
      background:#fff; cursor:pointer; font-size:12px; font-weight:800; display:inline-flex; align-items:center; gap:4px;
    }
    .op.approve{background:#ecfeff; border-color:#bae6fd}
    .op.delete{background:#fff1f1; border-color:#ffe4e6}
    .badge{
      padding:2px 8px; border-radius:999px; border:1px solid var(--line); font-size:11px; font-weight:900; color:#0f172a; background:#f9fafb
    }
  </style>
  
   <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#BBCF38">
  
</head>
<body>

  <!-- الشريط العلوي -->
  <header class="topbar">
    <div class="brand"><span class="dot"></span><span>نظام الشركة</span></div>
    <div style="display:flex; gap:8px; align-items:center">
      <button class="btn" id="refreshBtn" title="تحديث"><span class="ms">refresh</span></button>
      <button class="btn" id="backBtn" title="رجوع"><span class="ms">arrow_back_ios_new</span></button>
    </div>
  </header>

  <!-- المحتوى -->
  <main class="wrap">
    <section class="card">
      <div class="tools">
        <div id="live" class="pill live-ok"><span class="ms">online_prediction</span><span>متصل</span></div>
        <div class="pill" title="تحديث تلقائي"><span class="ms">schedule</span>10s</div>
      </div>
      <div id="list" class="list"></div>
      <div id="empty" class="empty" style="display:none">لا توجد بيانات.</div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $ = s=>document.querySelector(s);

    /* ===== إعدادات Firebase ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ===== إعدادات الصفحة ===== */
    const DASHBOARD = '/admin/core/dashboard.html';
    const AUTO_REFRESH_MS = 10000;

    // رجوع وتحديث
    $("#backBtn").addEventListener('click', ()=>{ if(history.length>1) history.back(); else window.location.replace(DASHBOARD); });
    $("#refreshBtn").addEventListener('click', ()=> fetchAndRender(true));

    function toast(m){ const t=$("#toast"); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); }
    function setLive(ok){
      const live = $("#live");
      live.className = "pill " + (ok ? "live-ok" : "live-bad");
      live.querySelector('.ms').textContent = ok ? 'online_prediction' : 'report_gmailerrorred';
      live.lastChild.textContent = ok ? 'متصل' : 'غير متصل';
    }

    // مراقبة الاتصال بالقاعدة
    db.ref(".info/connected").on("value", s=> setLive(!!s.val()));

    // كاش بيانات المستخدم
    const userCache = new Map();
    async function fetchUser(uid){
      if(!uid) return null;
      if(userCache.has(uid)) return userCache.get(uid);
      const snap = await db.ref('users/'+uid).get().catch(()=>null);
      const val = (snap && snap.exists()) ? snap.val() : null;
      userCache.set(uid, val);
      return val;
    }

    // قراءة الإيداعات
    async function fetchDeposits(){
      const rows = [];

      const snapLinked = await db.ref('deposits').get().catch(()=>null);
      if (snapLinked && snapLinked.exists()){
        const obj = snapLinked.val();
        Object.keys(obj).forEach(uid=>{
          const children = obj[uid] || {};
          Object.keys(children).forEach(k=>{
            rows.push(mapRow(children[k], `deposits/${uid}/${k}`));
          });
        });
      }

      const snapUn = await db.ref('deposits_unlinked').get().catch(()=>null);
      if (snapUn && snapUn.exists()){
        const children = snapUn.val();
        Object.keys(children).forEach(k=>{
          rows.push(mapRow(children[k], `deposits_unlinked/${k}`));
        });
      }

      // استكمال الاسم/ID من users عند الحاجة
      const need = [...new Set(rows.filter(r=>((!r.name || r.name==='—') || !r.accountId) && r.uid).map(r=>r.uid))];
      await Promise.all(need.map(async uid=>{
        const u = await fetchUser(uid);
        rows.forEach(r=>{
          if(r.uid===uid){
            if((!r.name || r.name==='—') && u && u.name) r.name = u.name;
            if(!r.accountId && u && u.accountId) r.accountId = u.accountId;
          }
        });
      }));

      rows.sort((a,b)=> (b.ts||0) - (a.ts||0));
      return rows;
    }

    function mapRow(r, keyPath){
      const netName = r.networkName || r.network || r.net || '';
      const chain   = r.chain || r.networkChain || '';
      const net     = (netName ? netName : '') + (chain ? `-${chain}` : '');

      let tsMs = null;
      if (typeof r.createdAt === 'number') tsMs = r.createdAt;
      else if (typeof r.createdAt === 'string') tsMs = Date.parse(r.createdAt);
      else if (typeof r.clientTime === 'number') tsMs = r.clientTime;

      return {
        key: keyPath,
        uid: r.uid || null,
        name: r.name || '—',
        accountId: r.accountId || null,
        net:  net || '—',
        amt:  Number(r.amount ?? 0),
        ts:   tsMs,
        tsLocal: tsMs ? new Date(tsMs).toLocaleString() : '-',
        status: r.status || 'pending'
      };
    }

    function fmtAmt(n){ return Number(n||0).toFixed(2); }

    function render(rows){
      const cont = $("#list"), empty=$("#empty");
      cont.innerHTML = '';

      if(!rows.length){ empty.style.display='block'; return; }
      empty.style.display='none';

      rows.forEach(x=>{
        const idText = x.accountId ? String(x.accountId) : (x.uid ? String(x.uid) : '-');
        const d = document.createElement('div');
        d.className = 'row';
        d.dataset.key = x.key;
        d.innerHTML = `
          <span class="name">${x.name}</span>
          <span class="sep">·</span>
          <span class="idtxt">${idText}</span>
          <span class="sep">·</span>
          <span>${x.net}</span>
          <span class="sep">·</span>
          <span class="amt">${fmtAmt(x.amt)}</span>
          <span class="sep">·</span>
          <span class="time">${x.tsLocal}</span>
          <span class="sep">·</span>
          <span class="badge">${x.status === 'approved' ? 'معتمد' : 'قيد المراجعة'}</span>
          <div class="ops">
            <button class="op approve" title="اعتماد"><span class="ms">check</span>اعتماد</button>
            <button class="op delete"  title="حذف"><span class="ms">delete</span>حذف</button>
          </div>
        `;
        cont.appendChild(d);
      });
    }

    // اعتماد
    async function approveDeposit(key){
      await db.ref(key).update({
        status: 'approved',
        approvedAt: firebase.database.ServerValue.TIMESTAMP
      });
    }

    // حذف
    async function deleteDeposit(key){
      await db.ref(key).remove();
    }

    // عمليات الأزرار
    $("#list").addEventListener('click', async (e)=>{
      const btnApprove = e.target.closest('.op.approve');
      const btnDelete  = e.target.closest('.op.delete');
      const row = e.target.closest('.row');
      if(!row) return;
      const key = row.dataset.key;

      try{
        if(btnApprove){
          btnApprove.disabled = true;
          await approveDeposit(key);
          const badge = row.querySelector('.badge');
          if(badge) badge.textContent = 'معتمد';
          toast('تم الاعتماد');
        }
        if(btnDelete){
          btnDelete.disabled = true;
          await deleteDeposit(key);
          row.remove();
          if(!$("#list").children.length) $("#empty").style.display='block';
          toast('تم الحذف');
        }
      }catch(err){
        console.error(err);
        toast('تعذّر التنفيذ');
        if(btnApprove) btnApprove.disabled = false;
        if(btnDelete)  btnDelete.disabled  = false;
      }
    });

    async function fetchAndRender(showToast){
      try{
        const rows = await fetchDeposits();
        render(rows);
        if(showToast) toast('تم التحديث');
      }catch(e){
        console.error(e);
        toast('تعذّر الاتصال');
      }
    }

    // تشغيل
    fetchAndRender(false);
    setInterval(()=>fetchAndRender(false), AUTO_REFRESH_MS);
  })();
  </script>
  
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
</script>
  
</body>
</html>