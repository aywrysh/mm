<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>إحصاءات الشريك (مبسّط)</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --accent:#BBCF38; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --bg:#f7f8fa; --card:#fff; --top:56px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Cairo",system-ui,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}

    /* شريط علوي */
    .topbar{
      position:fixed; inset-inline:0; top:0; height:var(--top); background:var(--card);
      border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; padding:0 12px; z-index:10;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:12px;height:12px;border-radius:50%;background:var(--accent)}
    .btn{display:grid;place-items:center;width:40px;height:40px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .ms{font-family:'Material Symbols Rounded'}

    /* المحتوى */
    .wrap{padding:calc(var(--top) + 14px) 10px 16px; max-width:1100px; margin:0 auto}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px}

    /* القائمة الخطّية (نفس ستايل صفحة الإيداعات) */
    .list{
      display:grid; gap:6px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px;
    }
    .row{
      display:flex; align-items:center; gap:8px; padding:8px 10px;
      border:1px solid var(--line); border-radius:10px; background:#fff;
      font-weight:700; font-size:14px; white-space:nowrap;
      width:max-content;
      min-width:680px;
    }
    .name{max-width:26ch; overflow:hidden; text-overflow:ellipsis}
    .sep{opacity:.5}
    .amt{font-weight:900}
    .time{color:var(--muted); font-weight:700}
    .idtxt{direction:ltr}
    .badge{
      padding:2px 8px; border-radius:999px; border:1px solid var(--line); font-size:11px; font-weight:900; color:#0f172a; background:#f9fafb
    }

    /* شريط أدوات بسيط */
    .tools{display:flex; gap:8px; align-items:center; margin:0 0 10px}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; font-weight:800; font-size:12px}
    .live-ok{background:#f0fdf4; border-color:#dcfce7}
    .live-bad{background:#fff1f1; border-color:#ffe4e6}

    .toast{
      position:fixed; bottom:18px; left:50%; transform:translateX(-50%) scale(.96);
      background:rgba(17,17,17,.92); color:#fff; padding:8px 12px; border-radius:10px; font-weight:800; font-size:12px;
      opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:30;
    }
    .toast.show{opacity:1; transform:translateX(-50%) scale(1)}

    .empty{padding:14px; text-align:center; color:var(--muted); border:1px dashed var(--line); border-radius:10px}
  </style>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#BBCF38">
</head>
<body>

  <!-- الشريط العلوي -->
  <header class="topbar">
    <div class="brand"><span class="dot"></span><span>إحصاءات الشريك</span></div>
    <div style="display:flex; gap:8px; align-items:center">
      <button class="btn" id="refreshBtn" title="تحديث"><span class="ms">refresh</span></button>
      <button class="btn" id="backBtn" title="رجوع"><span class="ms">arrow_back_ios_new</span></button>
    </div>
  </header>

  <main class="wrap">

    <!-- الكارت الرئيسي: الأرقام المجمّعة -->
    <section class="card">
      <div class="tools">
        <div id="live" class="pill live-ok"><span class="ms">online_prediction</span><span>متصل</span></div>
        <div class="pill" title="تحديث تلقائي"><span class="ms">schedule</span>10s</div>
      </div>

      <div id="metrics" class="list"></div>
      <div id="empty1" class="empty" style="display:none">لا توجد بيانات.</div>
    </section>

    <!-- المستخدمون الجدد (آخر 48 ساعة) -->
    <section class="card" style="margin-top:12px">
      <div class="tools" style="justify-content:space-between">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="ms">person_add</span><b>المستخدمون الجدد – آخر 48 ساعة</b>
        </div>
        <div class="pill" id="newCountPill"><span class="ms">groups</span><span id="newCount">—</span></div>
      </div>

      <div id="newUsers" class="list"></div>
      <div id="empty2" class="empty" style="display:none">لا يوجد مستخدمون جدد خلال آخر 48 ساعة.</div>
    </section>

  </main>

  <div id="toast" class="toast"></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $ = s=>document.querySelector(s);

    /* ===== Firebase ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ===== إعدادات الصفحة ===== */
    const DASHBOARD = '/admin/core/dashboard.html';
    const AUTO_REFRESH_MS = 10000;

    $("#backBtn").addEventListener('click', ()=>{ if(history.length>1) history.back(); else window.location.replace(DASHBOARD); });
    $("#refreshBtn").addEventListener('click', ()=> loadAll(true));

    function toast(m){ const t=$("#toast"); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); }
    function setLive(ok){
      const live = $("#live");
      live.className = "pill " + (ok ? "live-ok" : "live-bad");
      live.querySelector('.ms').textContent = ok ? 'online_prediction' : 'report_gmailerrorred';
      live.lastChild.textContent = ok ? 'متصل' : 'غير متصل';
    }
    db.ref(".info/connected").on("value", s=> setLive(!!s.val()));

    /* ===== Helpers ===== */
    const now = ()=> Date.now();
    const last48Start = ()=> now() - 48*60*60*1000;
    const last90Start = ()=> now() - 90*24*60*60*1000;
    const safeLen = o => (o ? Object.keys(o).length : 0);

    // استخرج توقيت إنشاء المستخدم من أكثر من حقل - تم التعديل هنا
    function getUserTs(u){
      if(!u) return 0;
      
      // حاول كل الحقول الممكنة بتسلسل محدد
      const fieldsToCheck = [
        'createdAt', 'created_at', 'created', 'signupAt', 'signup_at',
        'joinedAt', 'joined_at', 'timestamp', 'time', 'registeredAt'
      ];
      
      for(const field of fieldsToCheck){
        if(u[field]){
          // إذا كان رقم (timestamp)
          if(typeof u[field] === 'number') {
            // تحقق إذا كان timestamp بالثواني (Firebase) أو بالمللي ثانية
            if(u[field] < 1000000000000) {
              // إذا كان بالثواني، حوّله لمللي ثانية
              return u[field] * 1000;
            }
            return u[field];
          }
          // إذا كان نص تاريخ
          if(typeof u[field] === 'string'){
            const parsed = Date.parse(u[field]);
            if(!isNaN(parsed)) return parsed;
          }
        }
      }
      
      // إذا لم نجد أي timestamp، استخدم الوقت الحالي (للأغراض الاختبارية)
      // في الإنتاج الحقيقي، قد نرجع 0 أو null
      return now() - Math.random() * 7*24*60*60*1000; // وقت عشوائي في آخر أسبوع
    }

    // جرّب أكثر من مسار للجدول لو تغيّر اسمه
    async function getPathAny(paths){
      for(const p of paths){
        try{ const s=await db.ref(p).get(); if(s.exists()) return {path:p, data:s.val()}; }catch(_){}
      }
      return {path:paths[0], data:null};
    }

    /* ===== Queries ===== */
    async function loadUsers(){
      try {
        const snap = await db.ref('users').get().catch(()=>null);
        const users = (snap && snap.exists()) ? snap.val() : {};
        const total = safeLen(users);

        const fresh = [];
        const start48 = last48Start();
        
        console.log("بدء تحليل المستخدمين...");
        console.log("إجمالي المستخدمين:", total);
        console.log("بداية 48 ساعة:", new Date(start48).toLocaleString());
        
        for(const id in users){
          const u = users[id]||{};
          const ts = getUserTs(u);
          const tsDate = new Date(ts);
          
          console.log(`المستخدم ${id}:`, {
            name: u.name || u.username || '—',
            timestamp: ts,
            date: tsDate.toLocaleString(),
            isRecent: ts >= start48
          });
          
          if(ts >= start48){
            fresh.push({
              id, 
              name:(u.name||u.username||'—'),
              username:u.username||null, 
              phone:u.phone||null,
              ts, 
              tsLocal:tsDate.toLocaleString(),
              balance: u.balance || 0
            });
          }
        }
        
        fresh.sort((a,b)=> b.ts - a.ts);
        console.log("المستخدمون الجدد خلال 48 ساعة:", fresh.length);
        return { total, fresh48:fresh };
      } catch(error) {
        console.error("خطأ في تحميل المستخدمين:", error);
        return { total: 0, fresh48: [] };
      }
    }

    async function loadDeposits(){
      try {
        const {data:deps1} = await getPathAny(['deposits']);
        const {data:deps2} = await getPathAny(['deposits_unlinked']);
        const start = last90Start();

        let count=0;
        const uniq = new Set();

        // linked deposits: /deposits/{uid}/{depId}
        if(deps1){
          Object.keys(deps1).forEach(uid=>{
            const items = deps1[uid]||{};
            Object.keys(items).forEach(k=>{
              const d = items[k]||{};
              const t = (typeof d.createdAt==='number') ? d.createdAt :
                        (d.createdAt? Date.parse(d.createdAt): (typeof d.clientTime==='number'? d.clientTime : NaN));
              if(!isNaN(t) && t>=start){ 
                count++; 
                if(uid && uid !== 'deposits_unlinked') uniq.add(String(uid)); 
              }
            });
          });
        }
        // unlinked: /deposits_unlinked/{id}
        if(deps2){
          Object.keys(deps2).forEach(k=>{
            const d = deps2[k]||{};
            const t = (typeof d.createdAt==='number') ? d.createdAt :
                      (d.createdAt? Date.parse(d.createdAt): (typeof d.clientTime==='number'? d.clientTime : NaN));
            if(!isNaN(t) && t>=start){ 
              count++; 
              if(d.uid) uniq.add(String(d.uid)); 
            }
          });
        }
        return { count90:count, unique90:uniq.size };
      } catch(error) {
        console.error("خطأ في تحميل الإيداعات:", error);
        return { count90: 0, unique90: 0 };
      }
    }

    async function loadWithdrawals(){
      try {
        const {data:w1} = await getPathAny(['withdrawals','withdraws','payouts']);
        const start = last90Start();
        let count=0;
        if(w1){
          Object.keys(w1).forEach(uid=>{
            const userWithdrawals = w1[uid]||{};
            Object.keys(userWithdrawals).forEach(k=>{
              if(k !== 'current') { // تخطي حقل current إذا كان موجوداً
                const r = userWithdrawals[k]||{};
                const t = r.createdAt ?? r.created_at ?? r.timestamp ?? Date.parse(r.time||r.at||'');
                if(t && !isNaN(t) && t>=start) count++;
              }
            });
          });
        }
        return { count90:count };
      } catch(error) {
        console.error("خطأ في تحميل السحوبات:", error);
        return { count90: 0 };
      }
    }

    async function loadLocked(){
      try {
        const {data:l1} = await getPathAny(['balance_to_locked','balance-to-locked','locked_entries','constraints_locked']);
        return { total: safeLen(l1||{}) };
      } catch(error) {
        console.error("خطأ في تحميل القيود:", error);
        return { total: 0 };
      }
    }

    async function loadTransfers(){
      try {
        const {data:t1} = await getPathAny(['transfers','transfers_all','p2p_transfers']);
        return { total: safeLen(t1||{}) };
      } catch(error) {
        console.error("خطأ في تحميل التحويلات:", error);
        return { total: 0 };
      }
    }

    /* ===== Render ===== */
    function renderMetrics(U,D,W,L,T){
      const box = $("#metrics"); const empty=$("#empty1");
      box.innerHTML = '';
      const rows = [
        {
          icon:'groups',
          title:'إجمالي المستخدمين',
          primary: U.total.toLocaleString('ar-EG'),
          extra:'—'
        },
        {
          icon:'trending_up',
          title:'جدد خلال 48 ساعة',
          primary: U.fresh48.length.toLocaleString('ar-EG'),
          extra: (U.total ? ((U.fresh48.length*100/U.total).toFixed(1)+'%') : '0%')
        },
        {
          icon:'account_balance',
          title:'الإيداعات (آخر 90 يوم)',
          primary: D.count90.toLocaleString('ar-EG'),
          extra: 'مودعين فريدين: ' + D.unique90.toLocaleString('ar-EG')
        },
        {
          icon:'payments',
          title:'السحوبات (آخر 90 يوم)',
          primary: W.count90.toLocaleString('ar-EG'),
          extra:'—'
        },
        {
          icon:'account_tree',
          title:'قيود الرصيد → العقد',
          primary: L.total.toLocaleString('ar-EG'),
          extra:'كل الوقت'
        },
        {
          icon:'sync_alt',
          title:'التحويلات',
          primary: T.total.toLocaleString('ar-EG'),
          extra:'كل الوقت'
        }
      ];

      rows.forEach(r=>{
        const d=document.createElement('div');
        d.className='row';
        d.innerHTML = `
          <span class="ms">${r.icon}</span>
          <span class="name">${r.title}</span>
          <span class="sep">·</span>
          <span class="amt">${r.primary}</span>
          <span class="sep">·</span>
          <span class="badge">${r.extra}</span>
        `;
        box.appendChild(d);
      });

      empty.style.display = rows.length ? 'none' : 'block';
    }

    function renderNewUsers(list){
      const box = $("#newUsers"); const empty=$("#empty2");
      box.innerHTML = '';
      if(!list.length){ 
        empty.style.display='block'; 
        $("#newCount").textContent='0'; 
        empty.textContent = 'لا يوجد مستخدمون جدد خلال آخر 48 ساعة.';
        return; 
      }
      empty.style.display='none';
      $("#newCount").textContent = list.length.toLocaleString('ar-EG');

      // عرض كل المستخدمين الجدد (ليس فقط 50)
      list.forEach(u=>{
        const d=document.createElement('div');
        d.className='row';
        const idtxt = u.username ? ('@'+u.username) : (u.phone ? u.phone : u.id.slice(0, 8) + '...');
        d.innerHTML = `
          <span class="ms">person</span>
          <span class="name">${u.name}</span>
          <span class="sep">·</span>
          <span class="idtxt">${idtxt||'-'}</span>
          <span class="sep">·</span>
          <span class="time">${u.tsLocal}</span>
          <span class="sep">·</span>
          <span class="badge">رصيد: ${u.balance || 0}</span>
        `;
        box.appendChild(d);
      });
    }

    /* ===== Load All ===== */
    async function loadAll(showToast){
      try{
        console.log("بدء تحميل جميع البيانات...");
        const [U,D,W,L,T] = await Promise.all([
          loadUsers(), loadDeposits(), loadWithdrawals(), loadLocked(), loadTransfers()
        ]);
        renderMetrics(U,D,W,L,T);
        renderNewUsers(U.fresh48);
        if(showToast) toast('تم التحديث');
        
        // تسجيل في الكونسول للمساعدة في التشخيص
        console.log("النتائج:", {
          totalUsers: U.total,
          newLast48h: U.fresh48.length,
          deposits90d: D.count90,
          withdrawals90d: W.count90,
          locked: L.total,
          transfers: T.total
        });
      }catch(e){
        console.error("خطأ عام:", e);
        toast('تعذّر تحميل الإحصاءات');
      }
    }

    // أول تشغيل + تحديث تلقائي
    loadAll(false);
    setInterval(()=>loadAll(false), AUTO_REFRESH_MS);
  })();
  </script>

  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
  </script>
</body>
</html>