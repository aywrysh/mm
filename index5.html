<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>قيود: من الرصيد → العقد المقفل</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --accent:#BBCF38; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --bg:#f7f8fa; --card:#fff; --top:56px; --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Cairo",system-ui,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}

    /* الشريط العلوي */
    .topbar{
      position:fixed; inset-inline:0; top:0; height:var(--top); background:var(--card);
      border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; padding:0 10px; z-index:10;
    }
    .title{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    .btn{display:grid;place-items:center;width:40px;height:40px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .ms{font-family:'Material Symbols Rounded'}

    /* المحتوى */
    .wrap{padding:calc(var(--top) + 14px) 10px 18px; max-width:900px; margin:0 auto}
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:12px}

    /* الأدوات */
    .tools{display:flex; gap:8px; align-items:center; margin:0 0 12px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; font-weight:800; font-size:12px}
    .live-ok{background:#f0fdf4; border-color:#dcfce7}
    .live-bad{background:#fff1f1; border-color:#ffe4e6}

    /* القائمة */
    .list{display:grid; gap:8px}
    .row{
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      border:1px solid var(--line); border-radius:12px; background:#fff;
      font-weight:700; font-size:14px; flex-wrap:wrap;
    }
    .main{display:flex; gap:10px; align-items:center; min-width:260px; flex:1 1 480px; overflow:hidden; white-space:nowrap}
    .name{max-width:18ch; overflow:hidden; text-overflow:ellipsis}
    .sep{opacity:.5}
    .badge{padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#fafafa}
    .arrow{display:inline-flex; align-items:center; gap:4px; color:#334155}
    .amt{font-weight:900}
    .time{color:var(--muted); font-weight:700}
    .empty{padding:14px; text-align:center; color:var(--muted); border:1px dashed var(--line); border-radius:10px}

    .toast{
      position:fixed; bottom:18px; left:50%; transform:translateX(-50%) scale(.96);
      background:rgba(17,17,17,.92); color:#fff; padding:8px 12px; border-radius:10px; font-weight:800; font-size:12px;
      opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:30;
    }
    .toast.show{opacity:1; transform:translateX(-50%) scale(1)}
  </style>
  
   <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#BBCF38">
  
</head>
<body>

  <!-- الشريط العلوي (زر خروج بالأعلى) -->
  <header class="topbar">
    <button class="btn" id="backBtn" title="خروج"><span class="ms">arrow_back_ios_new</span></button>
    <div class="title"><span class="dot"></span><span>قيود التحويل</span></div>
    <button class="btn" id="refreshBtn" title="تحديث"><span class="ms">refresh</span></button>
  </header>

  <!-- المحتوى -->
  <main class="wrap">
    <section class="card">
      <div class="tools">
        <div id="live" class="pill live-ok"><span class="ms">online_prediction</span><span>متصل</span></div>
        <div class="pill" title="نوع العملية"><span class="ms">sync_alt</span><span>من الرصيد → العقد المقفل</span></div>
        <div class="pill" title="تحديث لحظي"><span class="ms">bolt</span><span>Realtime</span></div>
      </div>

      <div id="list" class="list"></div>
      <div id="empty" class="empty" style="display:none">لا توجد قيود حالياً.</div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- ✅ Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $ = s=>document.querySelector(s);
    const BACK_TO = 'index1.html#account';

    /* ===== أزرار ===== */
    $("#backBtn").addEventListener('click', ()=>{ if(history.length>1) history.back(); else window.location.replace(BACK_TO); });
    $("#refreshBtn").addEventListener('click', ()=>{ render(lastRows); toast('تم التحديث'); });
    function toast(m){ const t=$("#toast"); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); }
    function setLive(ok){
      const live = $("#live");
      live.className = "pill " + (ok ? "live-ok" : "live-bad");
      live.querySelector('.ms').textContent = ok ? 'online_prediction' : 'report_gmailerrorred';
      live.lastChild.textContent = ok ? 'متصل' : 'غير متصل';
    }

    /* ===== Firebase ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ===== كاش بيانات المستخدم ===== */
    const userCache = new Map(); // uid -> {name, accountId}
    async function getProfile(uid){
      if(!uid) return {name:'—', accountId:'—'};
      if(userCache.has(uid)) return userCache.get(uid);
      try{
        const snap = await db.ref('users/'+uid).get();
        const v = snap.val()||{};
        const prof = { name: v.name || v.username || '—', accountId: v.accountId || v.id || '—' };
        userCache.set(uid, prof);
        return prof;
      }catch(_){ return {name:'—', accountId:'—'}; }
    }

    /* ===== كشف إذا كان العقد ابن يحتوي سجلات أو سجل مفرد ===== */
    function looksLikeRecord(v){
      return v && (v.amount!=null || v.amt!=null || v.type==='BAL_TO_LOCK' || v.to==='locked' || v.lockedAmount!=null);
    }

    /* ===== توحيد الحقول ===== */
    function normalize(v, key, parentUid){
      const uid = v.uid || v.userUid || v.user_uid || v.ownerUid || parentUid || null;
      const amount = Number(v.amount ?? v.amt ?? v.delta ?? 0);
      const ts = v.createdAt || v.created_at || v.timestamp || v.ts || Date.now();
      const name = v.userName || v.user_name || v.name || null;
      return {
        id: key || v.id || v.ref || '',
        uid,
        userName: name, // قد نغذّيها لاحقاً من users
        amount,
        tsISO: new Date(ts).toISOString(),
        tsLocal: new Date(ts).toLocaleString()
      };
    }

    /* ===== جمع السجلات من عدة مسارات مدعومة =====
       - ledger/balanceToLocked/{uid}/{tx}
       - balanceToLocked/{uid}/{tx}
       - balanceToLocked/{tx}
    */
    const refs = [
      db.ref('ledger/balanceToLocked'),
      db.ref('balanceToLocked')
    ];

    let lastRows = [];

    async function handleSnapshot(snap){
      const rows = [];
      snap.forEach(l1=>{
        const v1 = l1.val();
        if(looksLikeRecord(v1)){
          rows.push( normalize(v1, l1.key, null) );
        }else{
          // طبقة uid -> tx
          l1.forEach(l2=>{
            const v2 = l2.val()||{};
            rows.push( normalize(v2, l2.key, l1.key) );
          });
        }
      });

      // إكمال أسماء المستخدمين من users/{uid} عند الحاجة
      const need = Array.from(new Set(rows.filter(r=>(!r.userName && r.uid)).map(r=>r.uid)));
      await Promise.all( need.map(uid=>getProfile(uid)) );
      rows.forEach(r=>{
        if((!r.userName) && r.uid){
          const p = userCache.get(r.uid) || {};
          r.userName = p.name || '—';
        }
      });

      lastRows = rows;
      render(rows);
    }

    // سنستمع لأول مسار موجود؛ وإن كان فارغًا نجرّب الآخر
    function attachListeners(){
      // ألغِ أي مستمعات قديمة
      refs.forEach(ref=>ref.off('value'));

      // جرّب الأول
      refs[0].once('value').then(s=>{
        if(s.exists()){
          setLive(true);
          refs[0].on('value', handleSnapshot, _=>setLive(false));
        }else{
          // جرّب الثاني
          refs[1].once('value').then(s2=>{
            if(s2.exists()){
              setLive(true);
              refs[1].on('value', handleSnapshot, _=>setLive(false));
            }else{
              // لا يوجد سجلات بعد
              lastRows = [];
              render([]);
            }
          });
        }
      }).catch(_=>{
        // في حال خطأ عام
        setLive(false);
      });
    }
    attachListeners();

    /* ===== عرض ===== */
    function fmtAmt(n){ return Number(n||0).toFixed(2); }
    function rowEl(x){
      const d = document.createElement('div');
      d.className = 'row';
      d.innerHTML = `
        <div class="main">
          <span class="name" title="${x.userName||'—'}">${x.userName||'—'}</span>
          <span class="sep">·</span>
          <span class="badge">من الرصيد</span>
          <span class="arrow"><span class="ms">arrow_back</span></span>
          <span class="badge">إلى العقد المقفل</span>
          <span class="sep">·</span>
          <span class="amt">${fmtAmt(x.amount)}</span>
          <span class="sep">·</span>
          <span class="time">${x.tsLocal || '-'}</span>
        </div>
      `;
      return d;
    }

    function render(rows){
      const cont = $("#list"), empty=$("#empty");
      cont.innerHTML = '';
      const sorted = (rows||[]).slice().sort((a,b)=> (b.tsISO||'').localeCompare(a.tsISO||''));
      if(!sorted.length){ empty.style.display='block'; setLive(true); return; }
      empty.style.display='none';
      sorted.forEach(x=> cont.appendChild(rowEl(x)));
    }
  })();
  </script>
  
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
</script>
  
  
  
</body>
</html>