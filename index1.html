<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم – الرئيسية</title>

  <!-- خط وأيقونات جوجل -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --accent:#BBCF38;
      --accent-2:#89A61B;

      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.10);

      --radius:18px;
      --shadow-lg:0 18px 40px rgba(2,6,23,.10);
      --shadow-md:0 10px 24px rgba(2,6,23,.08);
      --glow:0 0 0 6px rgba(187,207,56,.18);

      --chip: rgba(15,23,42,.06);
      --chip-2: rgba(187,207,56,.16);

      --bg-grad-1: rgba(187,207,56,.22);
      --bg-grad-2: rgba(15,23,42,.08);
      --body-start:#ffffff;
    }

    html[data-theme="dark"]{
      --bg:#0b1220;
      --card:rgba(17,24,39,.92);
      --ink:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(255,255,255,.10);

      --shadow-lg:0 18px 40px rgba(0,0,0,.35);
      --shadow-md:0 10px 24px rgba(0,0,0,.25);

      --chip: rgba(255,255,255,.08);
      --chip-2: rgba(187,207,56,.14);

      --bg-grad-1: rgba(187,207,56,.18);
      --bg-grad-2: rgba(255,255,255,.06);
      --body-start:#0b1220;
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Cairo",system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 420px at 95% -10%, var(--bg-grad-1) 0%, transparent 60%),
        radial-gradient(700px 360px at -10% 110%, var(--bg-grad-2) 0%, transparent 60%),
        linear-gradient(180deg, var(--body-start) 0%, var(--bg) 100%);
    }

    .ms{font-family:'Material Symbols Rounded'; line-height:1}

    .topbar{
      position:sticky; top:0; z-index:30;
      backdrop-filter:saturate(150%) blur(12px);
      background:rgba(255,255,255,.72);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px;
    }
    html[data-theme="dark"] .topbar{ background:rgba(15,23,42,.65); }

    .brand{display:flex; align-items:center; gap:10px; font-weight:900}
    .dot{
      width:12px;height:12px;border-radius:50%;
      background:linear-gradient(180deg,var(--accent),var(--accent-2));
      box-shadow:0 0 0 4px rgba(187,207,56,.22);
    }
    .top-actions{display:flex;gap:8px}

    .btn{
      width:40px;height:40px; display:grid; place-items:center; cursor:pointer;
      border:1px solid var(--line); border-radius:12px;
      background:rgba(255,255,255,.75);
      box-shadow:0 8px 16px rgba(2,6,23,.06);
      transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease;
    }
    html[data-theme="dark"] .btn{
      background:rgba(255,255,255,.06);
      box-shadow:0 8px 16px rgba(0,0,0,.25);
    }
    .btn:hover{border-color:rgba(187,207,56,.35); box-shadow:0 12px 26px rgba(2,6,23,.10), var(--glow)}
    .btn:active{transform:translateY(1px)}

    .container{max-width:1200px; margin:0 auto; padding:22px 14px 96px}

    .hero{
      position:relative;
      border-radius:calc(var(--radius) + 4px);
      padding:26px 22px 18px;
      background:
        radial-gradient(260px 160px at 10% 0%, rgba(187,207,56,.20), transparent 60%),
        radial-gradient(280px 170px at 95% -10%, rgba(15,23,42,.06), transparent 65%),
        var(--card);
      border:1px solid rgba(15,23,42,.08);
      box-shadow:var(--shadow-lg);
      display:grid; gap:10px; text-align:center; overflow:hidden; isolation:isolate;
      color:var(--ink);
    }
    html[data-theme="dark"] .hero{ border:1px solid rgba(255,255,255,.10); }

    .hero h1{margin:0; font-size:28px; font-weight:900; letter-spacing:.2px}
    .hero .hint{color:var(--muted); font-size:14px; font-weight:800}

    .hero-actions{
      display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
      margin-top:6px;
    }
    .hero-cta{
      display:inline-flex; align-items:center; gap:8px;
      padding:12px 18px; border-radius:14px; font-weight:900; text-decoration:none;
      background:linear-gradient(180deg, var(--accent), var(--accent-2));
      color:#0b120f;
      border:1px solid rgba(2,6,23,.12);
      box-shadow:0 14px 28px rgba(187,207,56,.28), 0 0 0 5px rgba(187,207,56,.16);
      transition:transform .1s ease, box-shadow .2s ease, filter .2s ease;
    }
    .hero-cta .ms{font-size:20px}
    .hero-cta:hover{ box-shadow:0 18px 40px rgba(187,207,56,.34), 0 0 0 7px rgba(187,207,56,.16); filter:saturate(112%) }
    .hero-cta:active{ transform:translateY(1px) }

    .hero-ghost{
      display:inline-flex; align-items:center; gap:8px;
      padding:12px 18px; border-radius:14px; font-weight:900; text-decoration:none;
      background:rgba(255,255,255,.80);
      color:var(--ink);
      border:1px solid rgba(15,23,42,.10);
      box-shadow:0 10px 22px rgba(2,6,23,.08);
      transition:transform .1s ease, box-shadow .2s ease, border-color .2s ease;
    }
    html[data-theme="dark"] .hero-ghost{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 10px 22px rgba(0,0,0,.25);
    }
    .hero-ghost .ms{font-size:20px; color:var(--accent-2)}
    .hero-ghost:hover{
      border-color:rgba(187,207,56,.45);
      box-shadow:0 14px 28px rgba(2,6,23,.10), var(--glow);
    }
    .hero-ghost:active{ transform:translateY(1px) }

    .section{
      margin-top:16px; border-radius:18px; padding:14px;
      background:var(--card);
      border:1px solid rgba(15,23,42,.08);
      box-shadow:var(--shadow-md);
    }
    html[data-theme="dark"] .section{ border:1px solid rgba(255,255,255,.10); }

    .section h2{
      margin:0 0 10px;
      font-size:16px; font-weight:900;
      color:var(--ink);
      display:flex; align-items:center; gap:8px;
    }

    .rows{display:grid;gap:10px}
    .row{
      display:flex; align-items:center; gap:10px; padding:12px 12px;
      border:1px solid rgba(15,23,42,.08); border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(246,247,251,.75));
      box-shadow:0 10px 18px rgba(2,6,23,.06);
    }
    html[data-theme="dark"] .row{
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 10px 18px rgba(0,0,0,.25);
    }
    .row .ms{
      color:var(--accent-2);
      background:rgba(187,207,56,.16);
      border:1px solid rgba(187,207,56,.24);
      width:38px;height:38px;border-radius:12px;
      display:grid; place-items:center;
      font-size:22px;
    }
    .row .name{font-weight:900}
    .row .sep{color:#94a3b8}
    .row .amt{font-weight:900; color:var(--ink)}
    .badge{
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background:var(--chip);
      font-weight:900; font-size:12px; color:var(--muted)
    }
    html[data-theme="dark"] .badge{ border:1px solid rgba(255,255,255,.10); }

    .users{display:grid;gap:10px}
    .empty{
      display:none; text-align:center; color:var(--muted); font-weight:900;
      padding:12px; border:1px dashed rgba(15,23,42,.18);
      border-radius:14px; background:rgba(255,255,255,.7)
    }
    html[data-theme="dark"] .empty{
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(255,255,255,.04);
    }

    .grid{ margin-top:16px; display:grid; gap:14px; grid-template-columns:repeat(4, minmax(0, 1fr)); }
    @media (max-width:1100px){ .grid{grid-template-columns:repeat(3, 1fr);} }
    @media (max-width:780px) { .grid{grid-template-columns:repeat(2, 1fr);} }
    @media (max-width:480px) { .grid{grid-template-columns:1fr;} }

    .tile{
      position:relative; overflow:hidden; cursor:pointer; isolation:isolate;
      background:var(--card);
      border:1px solid rgba(15,23,42,.10);
      border-radius:20px; padding:18px;
      display:flex; align-items:center; gap:12px;
      box-shadow:var(--shadow-md);
      color:var(--ink); text-decoration:none;
      transition:transform .15s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease;
    }
    html[data-theme="dark"] .tile{ border:1px solid rgba(255,255,255,.10); }
    .tile:hover{
      transform:translateY(-3px);
      border-color:rgba(187,207,56,.45);
      box-shadow:0 18px 40px rgba(2,6,23,.12), 0 0 0 6px rgba(187,207,56,.12);
      background:
        radial-gradient(140px 80px at 95% -20%, rgba(187,207,56,.22), transparent 60%),
        var(--card);
    }
    html[data-theme="dark"] .tile:hover{
      box-shadow:0 18px 40px rgba(0,0,0,.35), 0 0 0 6px rgba(187,207,56,.10);
      background:
        radial-gradient(140px 80px at 95% -20%, rgba(187,207,56,.16), transparent 60%),
        var(--card);
    }
    .tile:active{ transform:translateY(-1px) scale(.995); }

    .tile .icon{
      width:54px;height:54px; min-width:54px; border-radius:18px;
      background:linear-gradient(180deg, rgba(15,23,42,.06), rgba(15,23,42,.02));
      border:1px solid rgba(15,23,42,.10);
      display:grid; place-items:center;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.7);
    }
    html[data-theme="dark"] .tile .icon{
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:inset 0 1px 0 rgba(255,255,255,.08);
    }
    .tile .icon .ms{font-size:28px; color:var(--accent-2)}
    .tile .text{display:grid; gap:2px}
    .tile .title{font-weight:900; font-size:18px; color:var(--ink)}
    .tile .desc{font-size:12px; color:var(--muted); font-weight:800}
    .right{margin-inline-start:auto; color:#94a3b8; display:flex; align-items:center; gap:8px}
    .chip{
      font-weight:900; font-size:11px;
      padding:5px 10px; border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(15,23,42,.04);
      color:var(--muted);
    }
    html[data-theme="dark"] .chip{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
    }
    .chip-accent{
      border-color:rgba(187,207,56,.55);
      background:var(--chip-2);
      color:#2f3a05;
    }
    html[data-theme="dark"] .chip-accent{ color:#eaf5a9; }

    .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(2,6,23,.10);animation:ripple .6s linear;pointer-events:none}
    html[data-theme="dark"] .ripple{background:rgba(255,255,255,.14)}
    @keyframes ripple{to{transform:scale(3);opacity:0}}

    .fab{
      position:fixed; inset-inline-end:18px; bottom:18px; z-index:40;
      width:62px; height:62px; border-radius:20px; display:grid; place-items:center;
      background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#0b120f;
      border:1px solid rgba(2,6,23,.14);
      box-shadow:0 18px 44px rgba(187,207,56,.28), 0 0 0 7px rgba(187,207,56,.14);
      cursor:pointer; text-decoration:none; font-weight:900;
      transition:transform .1s ease, box-shadow .2s ease, filter .2s ease;
    }
    .fab:hover{ box-shadow:0 24px 56px rgba(187,207,56,.34), 0 0 0 9px rgba(187,207,56,.14); filter:saturate(112%) }
    .fab:active{ transform:translateY(1px) }
    .fab .ms{font-size:26px}

    .fab-label{
      position:fixed; inset-inline-end:92px; bottom:28px; z-index:40;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(15,23,42,.10);
      padding:8px 12px; border-radius:12px;
      font-weight:900; color:var(--ink);
      backdrop-filter:blur(10px);
      box-shadow:0 14px 28px rgba(2,6,23,.10);
    }
    html[data-theme="dark"] .fab-label{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 14px 28px rgba(0,0,0,.35);
    }

    #toast{
      position:fixed;bottom:24px;left:50%;
      transform:translateX(-50%) scale(.96);
      background:rgba(15,23,42,.92);
      color:#fff;padding:8px 12px;border-radius:12px;
      font-weight:900;font-size:12px;opacity:0;pointer-events:none;
      transition:.25s;z-index:70
    }
    #toast.show{opacity:1;transform:translateX(-50%) scale(1)}

    .theme-modal{
      position:fixed; inset:0; z-index:90;
      display:none; align-items:center; justify-content:center;
      background:rgba(2,6,23,.35);
      padding:16px;
    }
    .theme-modal.show{display:flex}
    .theme-panel{
      width:min(420px, 96vw);
      background:var(--card);
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;
      box-shadow:0 22px 60px rgba(2,6,23,.22);
      overflow:hidden;
    }
    html[data-theme="dark"] .theme-panel{
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 22px 60px rgba(0,0,0,.55);
    }
    .theme-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .theme-head .t{font-weight:900}
    .theme-body{padding:14px; display:grid; gap:10px}
    .theme-opt{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px; border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.65);
      cursor:pointer;
      font-weight:900;
    }
    html[data-theme="dark"] .theme-opt{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
    }
    .theme-opt:hover{
      border-color:rgba(187,207,56,.45);
      box-shadow:0 0 0 6px rgba(187,207,56,.12);
    }
    .theme-opt .l{display:flex; align-items:center; gap:10px}
    .theme-opt .b{
      width:14px;height:14px;border-radius:999px;
      border:2px solid rgba(15,23,42,.25);
    }
    html[data-theme="dark"] .theme-opt .b{border-color:rgba(255,255,255,.25)}
    .theme-opt.active .b{
      border-color:rgba(187,207,56,.85);
      box-shadow:0 0 0 5px rgba(187,207,56,.18) inset;
      background:rgba(187,207,56,.45);
    }
    .theme-foot{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; justify-content:flex-start; flex-wrap:wrap;
      background:rgba(255,255,255,.55);
    }
    html[data-theme="dark"] .theme-foot{background:rgba(255,255,255,.03)}
    .theme-btn{
      padding:10px 14px; border-radius:12px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.8);
      cursor:pointer; font-weight:900;
      display:inline-flex; align-items:center; gap:8px;
    }
    html[data-theme="dark"] .theme-btn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--ink);
    }

    /* ===== مودالات إنشاء الحساب + الصلاحيات ===== */
    .admin-modal{
      position:fixed; inset:0; z-index:95;
      display:none; align-items:center; justify-content:center;
      background:rgba(2,6,23,.35);
      padding:16px;
    }
    .admin-modal.show{display:flex}
    .admin-panel{
      width:min(520px, 96vw);
      background:var(--card);
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;
      box-shadow:0 22px 60px rgba(2,6,23,.22);
      overflow:hidden;
    }
    html[data-theme="dark"] .admin-panel{
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 22px 60px rgba(0,0,0,.55);
    }
    .admin-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    .admin-head .t{font-weight:900}
    .admin-body{padding:14px; display:grid; gap:10px}
    .frow{display:grid; gap:6px}
    .frow label{font-weight:900; color:var(--muted); font-size:12px}
    .frow input, .frow select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.85);
      outline:none;
      font-weight:900;
      color:var(--ink);
    }
    html[data-theme="dark"] .frow input, html[data-theme="dark"] .frow select{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--ink);
    }
    .admin-actions{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; flex-wrap:wrap;
      background:rgba(255,255,255,.55);
    }
    html[data-theme="dark"] .admin-actions{background:rgba(255,255,255,.03)}
    .a-btn{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.85);
      cursor:pointer;
      font-weight:900;
      display:inline-flex; align-items:center; gap:8px;
    }
    html[data-theme="dark"] .a-btn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--ink);
    }
    .a-btn.primary{
      background:linear-gradient(180deg, var(--accent), var(--accent-2));
      border:1px solid rgba(2,6,23,.14);
      color:#0b120f;
      box-shadow:0 14px 28px rgba(187,207,56,.22), 0 0 0 6px rgba(187,207,56,.12);
    }

    .perm-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:520px){ .perm-grid{grid-template-columns:1fr} }
    .perm-item{
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:10px 10px;
      background:rgba(255,255,255,.65);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:900;
    }
    html[data-theme="dark"] .perm-item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
    }
    .perm-item input{transform:scale(1.1)}
    .lockHint{
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      padding:10px 12px;
      border:1px dashed rgba(15,23,42,.16);
      border-radius:14px;
      background:rgba(255,255,255,.6);
    }
    html[data-theme="dark"] .lockHint{
      border:1px dashed rgba(255,255,255,.16);
      background:rgba(255,255,255,.04);
    }

    /* تعطيل حسب الصلاحيات */
    .locked{
      opacity:.45 !important;
      filter:grayscale(.2);
      pointer-events:none !important;
    }
  </style>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#BBCF38">
</head>

<body>

  <header class="topbar">
    <div class="brand"><span class="dot"></span><span>الرئيسية</span></div>
    <div class="top-actions">
      <button class="btn" id="refreshBtn" title="تحديث"><span class="ms">refresh</span></button>
      <button class="btn" id="settingsBtn" title="الإعدادات / الثيم"><span class="ms">settings</span></button>
      <button class="btn" id="helpBtn" title="مساعدة"><span class="ms">help</span></button>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>لوحة عمليات الشركة</h1>
      <div class="hint">اختر إحدى العمليات التالية لإدارتها بسرعة.</div>

      <div class="hero-actions">
        <a class="hero-cta ripple-container" href="index13.html" id="ctaCreateAnn" data-perm="index13.html">
          <span class="ms">campaign</span><span>إنشاء إعلان جديد</span>
        </a>

        <a class="hero-ghost ripple-container" href="index14.html" id="ctaAccounts" data-perm="index14.html">
          <span class="ms">manage_accounts</span><span>إدارة الحسابات</span>
        </a>
      </div>
    </section>

    <section class="section" id="liveStats">
      <h2>الإحصائيات المباشرة</h2>
      <div id="metrics" class="rows"></div>
      <div id="empty1" class="empty">لا يوجد بيانات لعرضها الآن.</div>
    </section>

    <section class="section">
      <h2>المستخدمون <span id="newCount" class="badge">0</span></h2>
      <div id="newUsers" class="users"></div>
      <div id="empty2" class="empty">لا يوجد مستخدمون جدد.</div>
    </section>

    <section class="grid">
      <a class="tile ripple-container" href="index2.html" data-perm="index2.html">
        <div class="icon"><span class="ms">account_balance_wallet</span></div>
        <div class="text"><div class="title">إيداع</div><div class="desc">تسجيل ومعاينة طلبات الإيداع</div></div>
        <div class="right"><span class="chip">جديد</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index3.html" data-perm="index3.html">
        <div class="icon"><span class="ms">payments</span></div>
        <div class="text"><div class="title">سحب</div><div class="desc">إدارة طلبات السحب واعتمادها</div></div>
        <div class="right"><span class="chip">مراجعة</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index4.html" data-perm="index4.html">
        <div class="icon"><span class="ms">sync_alt</span></div>
        <div class="text"><div class="title">تحويل</div><div class="desc">من حساب مستخدم لآخر</div></div>
        <div class="right"><span class="chip">نشط</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index5.html" data-perm="index5.html">
        <div class="icon"><span class="ms">account_tree</span></div>
        <div class="text"><div class="title">قيود التحويل</div><div class="desc">من الرصيد إلى العقد المقفل</div></div>
        <div class="right"><span class="chip">عرض</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index6.html" data-perm="index6.html">
        <div class="icon"><span class="ms">person_add</span></div>
        <div class="text"><div class="title">إنشاء حساب</div><div class="desc">إضافة مستخدم جديد للنظام</div></div>
        <div class="right"><span class="chip">إدارة</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index7.html" data-perm="index7.html">
        <div class="icon"><span class="ms">send</span></div>
        <div class="text"><div class="title">إرسال رسالة</div><div class="desc">إشعار أو تنبيه</div></div>
        <div class="right"><span class="chip">سريع</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index8.html" data-perm="index8.html">
        <div class="icon"><span class="ms">manage_search</span></div>
        <div class="text"><div class="title">عرض المستخدم</div><div class="desc">بحث ونسخ بيانات الحساب</div></div>
        <div class="right"><span class="chip">أدمن</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index9.html" data-perm="index9.html">
        <div class="icon"><span class="ms">list_alt</span></div>
        <div class="text"><div class="title">الإيداعات</div><div class="desc">سجل الإيداعات واعتمادها</div></div>
        <div class="right"><span class="chip">سجل</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index10.html" data-perm="index10.html">
        <div class="icon"><span class="ms">vpn_key</span></div>
        <div class="text">
          <div class="title">إنشاء حساب P2P</div>
          <div class="desc">تحقّق بالاسم والـID وإنشاء بيانات الدخول</div>
        </div>
        <div class="right"><span class="chip">P2P</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index11.html" data-perm="index11.html">
        <div class="icon"><span class="ms">forum</span></div>
        <div class="text">
          <div class="title">المقترحات والشكاوى</div>
          <div class="desc">مراجعة البلاغات والمقترحات</div>
        </div>
        <div class="right"><span class="chip">صندوق</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index13.html" id="tileCreateAnn" data-perm="index13.html">
        <div class="icon"><span class="ms">campaign</span></div>
        <div class="text"><div class="title">إنشاء إعلان</div><div class="desc">إعلان عام أو موجّه</div></div>
        <div class="right"><span class="chip chip-accent">إعلان</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index14.html" id="tileAccounts" data-perm="index14.html">
        <div class="icon"><span class="ms">manage_accounts</span></div>
        <div class="text"><div class="title">إدارة الحسابات</div><div class="desc">إدارة الحسابات والصلاحيات</div></div>
        <div class="right"><span class="chip">إدارة</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index15.html" id="tileSuspend" data-perm="index15.html">
        <div class="icon"><span class="ms">block</span></div>
        <div class="text"><div class="title">توقيف الحسابات</div><div class="desc">إيقاف/تفعيل الحسابات</div></div>
        <div class="right"><span class="chip">تحكم</span><span class="ms">chevron_left</span></div>
      </a>

      <a class="tile ripple-container" href="index16.html" id="tileTrash" data-perm="index16.html">
        <div class="icon"><span class="ms">delete_sweep</span></div>
        <div class="text"><div class="title">المحذوفات</div><div class="desc">عرض وإدارة المحذوفات</div></div>
        <div class="right"><span class="chip">سجل</span><span class="ms">chevron_left</span></div>
      </a>
    </section>
  </main>

  <a class="fab ripple-container" href="index13.html" id="fabCreateAnn" title="إنشاء إعلان" data-perm="index13.html">
    <span class="ms">campaign</span>
  </a>
  <div class="fab-label">إنشاء إعلان</div>

  <div id="toast"></div>

  <!-- مودال الثيم -->
  <div class="theme-modal" id="themeModal" aria-hidden="true">
    <div class="theme-panel" role="dialog" aria-modal="true" aria-label="إعدادات الثيم">
      <div class="theme-head">
        <div class="t">الإعدادات · الثيم</div>
        <button class="btn" id="closeTheme" title="إغلاق"><span class="ms">close</span></button>
      </div>

      <div class="theme-body">
        <div class="theme-opt" data-theme="light" id="optLight">
          <div class="l"><span class="ms">light_mode</span><span>فاتح</span></div>
          <span class="b"></span>
        </div>

        <div class="theme-opt" data-theme="dark" id="optDark">
          <div class="l"><span class="ms">dark_mode</span><span>داكن</span></div>
          <span class="b"></span>
        </div>
      </div>

      <div class="theme-foot">
        <button class="theme-btn" id="resetTheme"><span class="ms">restart_alt</span> إعادة الافتراضي</button>
        <button class="theme-btn" id="openCreateUser"><span class="ms">person_add</span> إنشاء حساب</button>
        <button class="theme-btn" id="openPerms"><span class="ms">admin_panel_settings</span> صلاحيات المستخدم</button>
      </div>
    </div>
  </div>

  <!-- مودال إنشاء حساب -->
  <div class="admin-modal" id="createUserModal" aria-hidden="true">
    <div class="admin-panel" role="dialog" aria-modal="true" aria-label="إنشاء حساب جديد">
      <div class="admin-head">
        <div class="t">إنشاء حساب جديد</div>
        <button class="btn" id="closeCreateUser" title="إغلاق"><span class="ms">close</span></button>
      </div>

      <div class="admin-body">
        <div class="lockHint">سيتم حفظ المستخدم في قاعدة البيانات داخل <b>system_auth_users</b>.</div>

        <div class="frow">
          <label>اسم المستخدم</label>
          <input id="cu_username" placeholder="مثال: ahmed" />
        </div>

        <div class="frow">
          <label>كلمة المرور</label>
          <input id="cu_password" placeholder="****" />
        </div>

        <div class="frow">
          <label>الدور</label>
          <select id="cu_role">
            <option value="user">مستخدم</option>
            <option value="admin">مدير</option>
          </select>
        </div>
      </div>

      <div class="admin-actions">
        <button class="a-btn" id="cu_cancel"><span class="ms">close</span> إلغاء</button>
        <button class="a-btn primary" id="cu_save"><span class="ms">save</span> حفظ المستخدم</button>
      </div>
    </div>
  </div>

  <!-- مودال الصلاحيات -->
  <div class="admin-modal" id="permModal" aria-hidden="true">
    <div class="admin-panel" role="dialog" aria-modal="true" aria-label="صلاحيات المستخدم">
      <div class="admin-head">
        <div class="t">صلاحيات المستخدم</div>
        <button class="btn" id="closePerms" title="إغلاق"><span class="ms">close</span></button>
      </div>

      <div class="admin-body">
        <div class="lockHint">
          اختر المستخدم ثم فعّل الصفحات المسموحة له.<br>
          (ملاحظة: مفاتيح الصلاحيات تُحفظ بشكل آمن بدون نقاط)
        </div>

        <div class="frow">
          <label>اختر المستخدم</label>
          <select id="perm_user_select"></select>
        </div>

        <div class="frow">
          <label>الصفحات المسموحة</label>
          <div class="perm-grid" id="perm_grid"></div>
        </div>
      </div>

      <div class="admin-actions">
        <button class="a-btn" id="perm_cancel"><span class="ms">close</span> إلغاء</button>
        <button class="a-btn primary" id="perm_save"><span class="ms">save</span> حفظ الصلاحيات</button>
      </div>
    </div>
  </div>

  <!-- Ripple + ثيم -->
  <script>
    document.addEventListener('click', e=>{
      const host = e.target.closest('.ripple-container'); if(!host) return;
      const r = document.createElement('span');
      const d = Math.max(host.clientWidth, host.clientHeight);
      const rect = host.getBoundingClientRect();
      r.className='ripple';
      r.style.width=r.style.height=d+'px';
      r.style.left=(e.clientX-rect.left-d/2)+'px';
      r.style.top=(e.clientY-rect.top-d/2)+'px';
      const old=host.querySelector('.ripple'); if(old) old.remove();
      host.appendChild(r); setTimeout(()=>r.remove(),600);
    });

    document.getElementById('refreshBtn').onclick = ()=>location.reload();
    document.getElementById('helpBtn').onclick    = ()=>alert('اختر أي صفحة من الشبكة. الصلاحيات تُدار من الإعدادات.');

    (function(){
      const KEY = "main_theme_choice";
      const html = document.documentElement;

      const modal = document.getElementById("themeModal");
      const settingsBtn = document.getElementById("settingsBtn");
      const closeBtn = document.getElementById("closeTheme");
      const resetBtn = document.getElementById("resetTheme");
      const optLight = document.getElementById("optLight");
      const optDark  = document.getElementById("optDark");

      function setActive(theme){
        [optLight,optDark].forEach(x=>x.classList.remove("active"));
        if(theme === "dark") optDark.classList.add("active");
        else optLight.classList.add("active");
      }
      function applyTheme(theme){
        if(theme === "dark") html.setAttribute("data-theme","dark");
        else html.setAttribute("data-theme","light");
        localStorage.setItem(KEY, theme);
        setActive(theme);
      }
      function open(){ modal.classList.add("show"); modal.setAttribute("aria-hidden","false"); }
      function close(){ modal.classList.remove("show"); modal.setAttribute("aria-hidden","true"); }

      const saved = localStorage.getItem(KEY) || "light";
      applyTheme(saved);

      settingsBtn.addEventListener("click", open);
      closeBtn.addEventListener("click", close);
      modal.addEventListener("click", (e)=>{ if(e.target === modal) close(); });

      optLight.addEventListener("click", ()=>applyTheme("light"));
      optDark.addEventListener("click",  ()=>applyTheme("dark"));

      resetBtn.addEventListener("click", ()=>{
        localStorage.removeItem(KEY);
        applyTheme("light");
      });
    })();

    (function(){
      const label = document.querySelector('.fab-label');
      if(!label) return;
      let lastY = window.scrollY;
      window.addEventListener('scroll', ()=>{
        const now = window.scrollY;
        const down = now > lastY;
        label.style.opacity = down ? '0' : '1';
        label.style.transform = down ? 'translateY(6px)' : 'translateY(0)';
        lastY = now;
      }, {passive:true});
    })();
  </script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- ✅ سكربت واحد فقط: إحصاءات + إنشاء حساب + صلاحيات + تطبيق الصلاحيات -->
  <script>
  (function(){
    const $ = s=>document.querySelector(s);
    const is = id=>document.getElementById(id);

    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };

    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function toast(m){
      const t=is("toast"); if(!t) return;
      t.textContent=m; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1500);
    }

    // Firebase يمنع . # $ / [ ]
    const permKeySafe = (k)=> String(k||"").replace(/[.#$/\[\]\/]/g, "_").replace(/\./g,"_");
    const enc = (s)=>encodeURIComponent(String(s||"").trim());

    /* ========= الإحصاءات ========= */
    const AUTO_REFRESH_MS = 10000;
    const now = ()=> Date.now();
    const last48Start = ()=> now() - 48*60*60*1000;
    const last90Start = ()=> now() - 90*24*60*60*1000;
    const safeLen = o => (o ? Object.keys(o).length : 0);
    const num = v => { const n=Number(v); return (isNaN(n)||!isFinite(n))?NaN:n; };

    function getUserName(u, fallbackId){
      return (
        u?.name ?? u?.fullName ?? u?.displayName ?? u?.realname ?? u?.nickname ?? u?.username ??
        (u?.accountId ? ('حساب ' + u.accountId) : (fallbackId || '—'))
      );
    }
    function getUserIdDisplay(u, uid){
      if(u?.username) return '@'+u.username;
      if(u?.phone) return u.phone;
      if(u?.accountId || u?.accountID || u?.accId) return String(u.accountId||u.accountID||u.accId);
      return uid;
    }
    function getUserTs(u){
      if(!u) return 0;
      const candidates = [u.created_ts, u.createdTs, u.createdAt, u.created_at, u.signupAt, u.joinedAt, u.time, u.at];
      for(const c of candidates){
        if(typeof c === 'number'){
          if(c > 1e11) return c;
          if(c > 1e9)  return c*1000;
        }else if(typeof c === 'string'){
          const n = num(c);
          if(!isNaN(n)){
            if(n > 1e11) return n;
            if(n > 1e9)  return n*1000;
          }
          const t = Date.parse(c);
          if(!isNaN(t)) return t;
        }
      }
      return 0;
    }
    async function getPathAny(paths){
      for(const p of paths){
        try{ const s=await db.ref(p).get(); if(s.exists()) return {path:p, data:s.val()}; }catch(_){}
      }
      return {path:paths[0], data:null};
    }

    async function loadUsers(){
      const snap = await db.ref('users').get().catch(()=>null);
      const users = (snap && snap.exists()) ? snap.val() : {};
      const total = safeLen(users);

      const all = [], fresh = [];
      const start48 = last48Start();

      for(const id in users){
        const u = users[id]||{};
        const ts = getUserTs(u);
        const name = getUserName(u, id);
        const disp = getUserIdDisplay(u, id);
        const item = {
          id, name: name || '—', idtxt: disp || id,
          ts: ts || 0,
          tsLocal: ts ? new Date(ts).toLocaleString('ar-EG', { hour12:false }) : '—'
        };
        all.push(item);
        if(ts && ts >= start48) fresh.push(item);
      }

      all.sort((a,b)=> b.ts - a.ts);
      fresh.sort((a,b)=> b.ts - a.ts);

      const showList = fresh.length ? fresh : all.slice(0, 100);
      const mode = fresh.length ? 'fresh' : 'fallback';
      return { total, fresh48:fresh, showList, mode };
    }

    async function loadDeposits(){
      const {data:deps1} = await getPathAny(['deposits']);
      const {data:deps2} = await getPathAny(['deposits_unlinked']);
      const start = last90Start();
      let count=0;
      const uniq = new Set();

      if(deps1){
        Object.keys(deps1).forEach(uid=>{
          const items = deps1[uid]||{};
          Object.keys(items).forEach(k=>{
            const d = items[k]||{};
            let t = num(d.createdAt);
            if(isNaN(t)){
              t = num(d.clientTime);
              if(isNaN(t)){
                const parsed = Date.parse(d.created_at||d.createdAt||d.time||d.at||'');
                t = isNaN(parsed)? NaN : parsed;
              }
            }
            if(!isNaN(t) && t>=start){ count++; if(uid) uniq.add(String(uid)); }
          });
        });
      }
      if(deps2){
        Object.keys(deps2).forEach(k=>{
          const d = deps2[k]||{};
          let t = num(d.createdAt);
          if(isNaN(t)){
            t = num(d.clientTime);
            if(isNaN(t)){
              const parsed = Date.parse(d.created_at||d.createdAt||d.time||d.at||'');
              t = isNaN(parsed)? NaN : parsed;
            }
          }
          if(!isNaN(t) && t>=start){ count++; if(d.uid) uniq.add(String(d.uid)); }
        });
      }
      return { count90:count, unique90:uniq.size };
    }

    async function loadWithdrawals(){
      const {data:w1} = await getPathAny(['withdrawals','withdraws','payouts']);
      const start = last90Start();
      let count=0;
      if(w1){
        const keys = Object.keys(w1);
        const firstKey = keys.length ? keys[0] : null;
        const firstVal = firstKey ? w1[firstKey] : null;
        const nested = firstVal && typeof firstVal === 'object' && !('created_ts' in firstVal) && !('created_at' in firstVal) && !('time' in firstVal);
        if(nested){
          Object.keys(w1).forEach(uid=>{
            const items=w1[uid]||{};
            Object.keys(items).forEach(k=>{
              const r=items[k]||{};
              const t = r.created_ts ?? num(r.createdAt) ?? Date.parse(r.created_at||r.time||r.at||'');
              if(!isNaN(t) && t>=start) count++;
            });
          });
        }else{
          Object.keys(w1).forEach(k=>{
            const r = w1[k]||{};
            const t = r.created_ts ?? num(r.createdAt) ?? Date.parse(r.created_at||r.time||r.at||'');
            if(!isNaN(t) && t>=start) count++;
          });
        }
      }
      return { count90:count };
    }

    async function loadLocked(){
      const {data:l1} = await getPathAny(['balance_to_locked','balance-to-locked','locked_entries','constraints_locked']);
      return { total: safeLen(l1||{}) };
    }

    async function loadTransfers(){
      const {data:t1} = await getPathAny(['transfers','transfers_all','p2p_transfers']);
      if(!t1) return { total:0 };
      let total=0;
      const keys = Object.keys(t1);
      const firstKey = keys.length ? keys[0] : null;
      const firstVal = firstKey ? t1[firstKey] : null;
      const nested = firstVal && typeof firstVal === 'object' && !('id' in firstVal) && !('amount' in firstVal) && !('from' in firstVal) && !('to' in firstVal);
      if(nested){
        Object.keys(t1).forEach(uid=>{ total += safeLen(t1[uid]); });
      }else{
        total = safeLen(t1);
      }
      return { total };
    }

    function renderMetrics(U,D,W,L,T){
      const box = $("#metrics");
      const empty=$("#empty1");
      if(!box || !empty) return;
      box.innerHTML = '';

      const rows = [
        { icon:'groups', title:'إجمالي المستخدمين', primary: U.total.toLocaleString('ar-EG'), extra:'—' },
        {
          icon:'trending_up',
          title:(U.mode==='fresh'?'جدد خلال 48 ساعة':'أحدث المستخدمين (لا يوجد جدد خلال 48 ساعة)'),
          primary: (U.mode==='fresh'? U.fresh48.length : U.showList.length).toLocaleString('ar-EG'),
          extra: (U.total ? (((U.mode==='fresh'? U.fresh48.length : U.showList.length)*100/U.total).toFixed(1)+'%') : '0%')
        },
        { icon:'account_balance', title:'الإيداعات (آخر 90 يوم)', primary: D.count90.toLocaleString('ar-EG'), extra: 'مودعين فريدين: ' + D.unique90.toLocaleString('ar-EG') },
        { icon:'payments', title:'السحوبات (آخر 90 يوم)', primary: W.count90.toLocaleString('ar-EG'), extra:'—' },
        { icon:'account_tree', title:'قيود الرصيد → العقد', primary: L.total.toLocaleString('ar-EG'), extra:'كل الوقت' },
        { icon:'sync_alt', title:'التحويلات', primary: T.total.toLocaleString('ar-EG'), extra:'كل الوقت' }
      ];

      rows.forEach(r=>{
        const d=document.createElement('div');
        d.className='row';
        d.innerHTML = `
          <span class="ms">${r.icon}</span>
          <span class="name">${r.title}</span>
          <span class="sep">·</span>
          <span class="amt">${r.primary}</span>
          <span class="sep">·</span>
          <span class="badge">${r.extra}</span>
        `;
        box.appendChild(d);
      });

      empty.style.display = rows.length ? 'none' : 'block';
    }

    function renderNewUsers(list){
      const box = $("#newUsers");
      const empty=$("#empty2");
      const newCount=$("#newCount");
      if(!box || !empty || !newCount) return;

      box.innerHTML = '';
      if(!list.length){ empty.style.display='block'; newCount.textContent='0'; return; }
      empty.style.display='none';
      newCount.textContent = list.length.toLocaleString('ar-EG');

      list.slice(0,100).forEach(u=>{
        const d=document.createElement('div');
        d.className='row';
        d.innerHTML = `
          <span class="ms">person</span>
          <span class="name" title="${u.name}">${u.name}</span>
          <span class="sep">·</span>
          <span class="idtxt">${u.idtxt||'-'}</span>
          <span class="sep">·</span>
          <span class="time">${u.tsLocal}</span>
          <span class="sep">·</span>
          <span class="badge">جديد</span>
        `;
        box.appendChild(d);
      });
    }

    async function loadAll(showToast){
      try{
        const [U,D,W,L,T] = await Promise.all([
          loadUsers(), loadDeposits(), loadWithdrawals(), loadLocked(), loadTransfers()
        ]);
        renderMetrics(U,D,W,L,T);
        renderNewUsers(U.showList);
        if(showToast) toast('تم التحديث');
      }catch(e){
        console.error(e);
        toast('تعذّر تحميل الإحصاءات');
      }
    }

    loadAll(false);
    setInterval(()=>loadAll(false), AUTO_REFRESH_MS);

    /* ========= إنشاء حساب + صلاحيات ========= */
    const AUTH_PATH = "users_v2";
    const STORE_KEY = "last_username";

    const createUserModal = is("createUserModal");
    const permModal = is("permModal");

    const openCreateUser = is("openCreateUser");
    const openPerms = is("openPerms");

    const closeCreateUser = is("closeCreateUser");
    const closePerms = is("closePerms");

    const cu_cancel = is("cu_cancel");
    const cu_save = is("cu_save");
    const cu_username = is("cu_username");
    const cu_password = is("cu_password");
    const cu_role = is("cu_role");

    const perm_user_select = is("perm_user_select");
    const perm_grid = is("perm_grid");
    const perm_cancel = is("perm_cancel");
    const perm_save = is("perm_save");

    const PERM_ITEMS = [
      { label:"الإعدادات", key:"settings" },
      { label:"إنشاء إعلان", key:"index13.html" },
      { label:"إدارة الحسابات", key:"index14.html" },
      { label:"توقيف الحسابات", key:"index15.html" },
      { label:"المحذوفات", key:"index16.html" },
      { label:"إيداع", key:"index2.html" },
      { label:"سحب", key:"index3.html" },
      { label:"تحويل", key:"index4.html" },
      { label:"قيود التحويل", key:"index5.html" },
      { label:"إنشاء حساب", key:"index6.html" },
      { label:"إرسال رسالة", key:"index7.html" },
      { label:"عرض المستخدم", key:"index8.html" },
      { label:"الإيداعات", key:"index9.html" },
      { label:"حساب P2P", key:"index10.html" },
      { label:"الشكاوى والمقترحات", key:"index11.html" }
    ];

    function showModal(modal){
      if(!modal) return;
      modal.classList.add("show");
      modal.setAttribute("aria-hidden","false");
    }
    function hideModal(modal){
      if(!modal) return;
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden","true");
    }

    if(openCreateUser) openCreateUser.addEventListener("click", ()=>showModal(createUserModal));
    if(openPerms) openPerms.addEventListener("click", async ()=>{
      showModal(permModal);
      await loadUsersToSelect();
    });

    [closeCreateUser, cu_cancel].forEach(btn=> btn && btn.addEventListener("click", ()=>hideModal(createUserModal)));
    [closePerms, perm_cancel].forEach(btn=> btn && btn.addEventListener("click", ()=>hideModal(permModal)));

    [createUserModal, permModal].forEach(m=>{
      if(!m) return;
      m.addEventListener("click",(e)=>{ if(e.target === m) hideModal(m); });
    });

    function defaultPermissions(){
      const permissions = {};
      PERM_ITEMS.forEach(x=>{
        // افتراض: إيداع/سحب/تحويل مسموح، والباقي لا
        const allowed = (x.key==="index2.html" || x.key==="index3.html" || x.key==="index4.html");
        permissions[permKeySafe(x.key)] = allowed;
      });
      permissions[permKeySafe("settings")] = true; // الإعدادات مسموحة للمدير فقط لاحقاً لو تحب
      return permissions;
    }

    if(cu_save){
      cu_save.addEventListener("click", async ()=>{
        const username = String(cu_username?.value||"").trim();
        const password = String(cu_password?.value||"").trim();
        const role = String(cu_role?.value||"user");

        if(!username || !password){
          toast("أدخل اسم المستخدم وكلمة المرور");
          return;
        }

        cu_save.disabled = true;

        try{
          const ref = db.ref(`${AUTH_PATH}/${enc(username)}`);
          const snap = await ref.get();

          if(snap.exists()){
            toast("اسم المستخدم موجود مسبقاً");
            return;
          }

          const permissions = defaultPermissions();

          await ref.set({
            username,
            password,
            role,
            createdAt: Date.now(),
            permissions
          });

          toast("تم إنشاء الحساب ✅");
          cu_username.value = "";
          cu_password.value = "";

          // بعد إنشاء المستخدم، حدّث قائمة الصلاحيات
          try{ await loadUsersToSelect(); }catch(_){}
          hideModal(createUserModal);

        }catch(err){
          console.error("Create user error:", err);
          if(String(err?.message||"").includes("permission_denied")){
            toast("❌ Permission denied (قواعد Firebase تمنع الكتابة)");
          }else{
            toast("❌ فشل إنشاء الحساب");
          }
        }finally{
          cu_save.disabled = false;
        }
      });
    }

    async function loadUsersToSelect(){
      if(!perm_user_select) return;
      perm_user_select.innerHTML = "";

      let data = {};
      try{
        const snap = await db.ref(AUTH_PATH).get();
        data = snap.exists() ? snap.val() : {};
      }catch(err){
        console.error("Load users error:", err);
        toast("تعذر تحميل المستخدمين");
        return;
      }

      const users = Object.keys(data || {}).map(k=>{
        const u = data[k] || {};
        return { key:k, username: u.username || decodeURIComponent(k) || k };
      }).sort((a,b)=> String(a.username).localeCompare(String(b.username), 'ar'));

      users.forEach(u=>{
        const opt = document.createElement("option");
        opt.value = u.username;
        opt.textContent = u.username;
        perm_user_select.appendChild(opt);
      });

      const current = localStorage.getItem(STORE_KEY) || "";
      if(current && users.some(x=>x.username===current)){
        perm_user_select.value = current;
      }else if(users.length){
        perm_user_select.value = users[0].username;
      }

      renderPermGrid();
      await loadPermsForSelected();
    }

    function renderPermGrid(){
      if(!perm_grid) return;
      perm_grid.innerHTML = "";
      PERM_ITEMS.forEach(item=>{
        const div = document.createElement("div");
        div.className = "perm-item";
        div.innerHTML = `
          <span>${item.label}</span>
          <input type="checkbox" data-permkey="${item.key}" />
        `;
        perm_grid.appendChild(div);
      });
    }

    async function loadPermsForSelected(){
      const username = String(perm_user_select?.value || "").trim();
      if(!username) return;

      try{
        const snap = await db.ref(`${AUTH_PATH}/${enc(username)}`).get();
        if(!snap.exists()) return;

        const user = snap.val() || {};
        const perms = user.permissions || {};

        perm_grid?.querySelectorAll('input[type="checkbox"][data-permkey]').forEach(cb=>{
          const k = cb.getAttribute("data-permkey");
          cb.checked = !!perms[permKeySafe(k)];
        });

        localStorage.setItem(STORE_KEY, username);
        applyPermissions(perms);

      }catch(err){
        console.error("Load perms error:", err);
        toast("تعذر تحميل الصلاحيات");
      }
    }

    if(perm_user_select){
      perm_user_select.addEventListener("change", loadPermsForSelected);
    }

    if(perm_save){
      perm_save.addEventListener("click", async ()=>{
        const username = String(perm_user_select?.value || "").trim();
        if(!username){
          toast("اختر مستخدم");
          return;
        }

        const perms = {};
        perm_grid?.querySelectorAll('input[type="checkbox"][data-permkey]').forEach(cb=>{
          const k = cb.getAttribute("data-permkey");
          perms[permKeySafe(k)] = cb.checked;
        });

        try{
          await db.ref(`${AUTH_PATH}/${enc(username)}/permissions`).set(perms);
          toast("تم حفظ الصلاحيات ✅");
          applyPermissions(perms);
          hideModal(permModal);
        }catch(err){
          console.error("Save perms error:", err);
          if(String(err?.message||"").includes("permission_denied")){
            toast("❌ Permission denied (قواعد Firebase تمنع الحفظ)");
          }else{
            toast("❌ فشل حفظ الصلاحيات");
          }
        }
      });
    }

    function applyPermissions(perms){
      // تعطيل زر الإعدادات (لو منعته)
      const settingsBtn = is("settingsBtn");
      if(settingsBtn){
        const allowed = (perms && perms[permKeySafe("settings")] === true);
        if(perms && (permKeySafe("settings") in perms) && !allowed) settingsBtn.classList.add("locked");
        else settingsBtn.classList.remove("locked");
      }

      // تعطيل الروابط حسب data-perm
      document.querySelectorAll('[data-perm]').forEach(el=>{
        const key = el.getAttribute("data-perm");
        if(!key) return;
        const sk = permKeySafe(key);

        if(perms && (sk in perms)){
          if(perms[sk] !== true) el.classList.add("locked");
          else el.classList.remove("locked");
        }
      });
    }

    // عند فتح الصفحة: طبّق صلاحيات آخر مستخدم مختار
    (async function bootPerms(){
      const current = localStorage.getItem(STORE_KEY) || "";
      if(!current) return;
      try{
        const snap = await db.ref(`${AUTH_PATH}/${enc(current)}`).get();
        if(!snap.exists()) return;
        const u = snap.val() || {};
        if(u.permissions) applyPermissions(u.permissions);
      }catch(e){
        console.error(e);
      }
    })();

  })();
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(()=>console.log("✔ Service Worker registered"))
        .catch(err => console.error("❌ Service Worker failed:", err));
    }
  </script>

</body>
</html>