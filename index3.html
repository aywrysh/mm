<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>السحوبات (لوحة الشركة)</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --accent:#BBCF38; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --bg:#f7f8fa; --card:#fff; --top:56px; --ok:#16a34a; --no:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Cairo",system-ui,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}

    /* الشريط العلوي */
    .topbar{
      position:fixed; inset-inline:0; top:0; height:var(--top); background:var(--card);
      border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; padding:0 12px; z-index:10;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:12px;height:12px;border-radius:50%;background:var(--accent)}
    .btn{display:grid;place-items:center;width:40px;height:40px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .ms{font-family:'Material Symbols Rounded'}

    /* المحتوى */
    .wrap{padding:calc(var(--top) + 14px) 10px 18px; max-width:1100px; margin:0 auto}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px}

    /* أدوات */
    .tools{display:flex; gap:8px; align-items:center; margin:0 0 12px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; font-weight:800; font-size:12px}
    .live-ok{background:#f0fdf4; border-color:#dcfce7}
    .live-bad{background:#fff1f1; border-color:#ffe4e6}

    /* القائمة الخطية */
    .list{display:grid; gap:8px}
    .row{
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      border:1px solid var(--line); border-radius:12px; background:#fff;
      font-weight:700; font-size:14px; flex-wrap:wrap;
    }
    .main{display:flex; gap:8px; align-items:center; min-width:280px; flex:1 1 520px; overflow:hidden; white-space:nowrap}
    .name{max-width:20ch; overflow:hidden; text-overflow:ellipsis}
    .id{color:var(--muted)}
    .sep{opacity:.5}
    .amt{font-weight:900}
    .time{color:var(--muted); font-weight:700}
    .net{padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#fafafa; font-weight:900; font-size:12px}
    .addr{font:600 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#f8fafc; border:1px dashed var(--line); padding:3px 6px; border-radius:8px}
    .actions{display:flex; gap:8px}
    .chip{padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#fff; font-weight:800; cursor:pointer}
    .ok{background:var(--ok); color:#fff; border-color:var(--ok)}
    .no{background:var(--no); color:#fff; border-color:var(--no)}
    .chip[disabled]{opacity:.6; cursor:not-allowed}
    .badge{padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px}
    .bd-ok{background:#dcfce7; color:#166534}
    .bd-no{background:#fee2e2; color:#991b1b}

    /* فاضي + توست */
    .empty{padding:14px; text-align:center; color:var(--muted); border:1px dashed var(--line); border-radius:10px}
    .toast{
      position:fixed; bottom:18px; left:50%; transform:translateX(-50%) scale(.96);
      background:rgba(17,17,17,.92); color:#fff; padding:8px 12px; border-radius:10px; font-weight:800; font-size:12px;
      opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:30;
    }
    .toast.show{opacity:1; transform:translateX(-50%) scale(1)}
  </style>
  
   <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#BBCF38">
  
</head>
<body>

  <!-- الشريط العلوي -->
  <header class="topbar">
    <div class="brand"><span class="dot"></span><span>نظام الشركة</span></div>
    <div style="display:flex; gap:8px; align-items:center">
      <button class="btn" id="refreshBtn" title="تحديث"><span class="ms">refresh</span></button>
      <button class="btn" id="backBtn" title="رجوع"><span class="ms">arrow_back_ios_new</span></button>
    </div>
  </header>

  <!-- المحتوى -->
  <main class="wrap">
    <section class="card">
      <div class="tools">
        <div id="live" class="pill live-ok"><span class="ms">online_prediction</span><span>متصل</span></div>
        <div class="pill" title="تحديث لحظي"><span class="ms">bolt</span><span>Realtime</span></div>
      </div>

      <div id="list" class="list"></div>
      <div id="empty" class="empty" style="display:none">لا توجد سحوبات.</div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- ✅ Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  (function(){
    const $ = s=>document.querySelector(s);

    /* ===== إعداد Firebase ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ===== واجهة عامة ===== */
    $("#backBtn").addEventListener('click', ()=>{ if(history.length>1) history.back(); else window.location.replace('/admin/core/dashboard.html'); });
    $("#refreshBtn").addEventListener('click', ()=>{ fetchAndRender(true); });

    function toast(m){ const t=$("#toast"); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); }
    function setLive(ok){
      const live = $("#live");
      live.className = "pill " + (ok ? "live-ok" : "live-bad");
      live.querySelector('.ms').textContent = ok ? 'online_prediction' : 'report_gmailerrorred';
      live.lastChild.textContent = ok ? 'متصل' : 'غير متصل';
    }

    /* ===== جلب أسماء المستخدمين (كاش بسيط) ===== */
    const userCache = new Map();
    async function getUserName(uid){
      if(userCache.has(uid)) return userCache.get(uid);
      try{
        const snap = await db.ref('users/'+uid+'/name').get();
        const name = snap.exists() ? (snap.val() || '—') : '—';
        userCache.set(uid, name);
        return name;
      }catch(_){ return '—'; }
    }

    /* ===== قراءة السحوبات لحظيًا ===== */
    const listRef = db.ref('withdrawals'); // بنية: withdrawals/{uid}/{withdrawId}
    let lastRows = []; // للـ refresh اليدوي

    function adapt(uid, id, v){
      const ts = v.createdAt || v.timestamp || null;
      return {
        id,
        uid,
        name: v.name || v.userName || userCache.get(uid) || '—',
        amount: Number(v.amount || v.amt || 0),
        fee: Number(v.fee ?? 1),
        net: Math.max(0, Number(v.amount||0) - Number(v.fee ?? 1)),
        network: v.network || v.net || '—',
        address: v.address || v.addr || '—',
        status: v.status || 'pending',
        tsISO: ts ? new Date(ts).toISOString() : '',
        tsLocal: ts ? new Date(ts).toLocaleString() : ''
      };
    }

    function shortAddr(a){
      a = String(a||'');
      return a.length > 16 ? (a.slice(0,7)+'…'+a.slice(-6)) : a;
    }

    function fmt(n){ return Number(n||0).toFixed(2); }

    function rowEl(x){
      const d = document.createElement('div');
      d.className = 'row';

      const statusBadge =
        x.status==='approved' ? `<span class="badge bd-ok">معتمد</span>` :
        x.status==='rejected' ? `<span class="badge bd-no">مرفوض</span>` : '';

      d.innerHTML = `
        <div class="main">
          <span class="name" title="${x.name}">${x.name}</span>
          <span class="sep">·</span>
          <span class="id" title="${x.uid}">${x.uid}</span>
          <span class="sep">·</span>
          <span class="net">${x.network}</span>
          <span class="sep">·</span>
          <span class="amt" title="صافي بعد الرسوم">${fmt(x.amount)} → ${fmt(x.net)}</span>
          <span class="sep">·</span>
          <span class="time">${x.tsLocal || '-'}</span>
          ${statusBadge ? `<span class="sep">·</span>${statusBadge}` : ''}
        </div>

        <div class="main" style="gap:6px;flex:1 1 420px">
          <span class="ms" aria-hidden="true">link</span>
          <span class="addr" title="${x.address}">${shortAddr(x.address)}</span>
          <button class="chip" data-copy="${x.address}"><span class="ms">content_copy</span> نسخ العنوان</button>
        </div>

        <div class="actions">
          <button class="chip ok" data-act="approve">اعتماد</button>
          <button class="chip no" data-act="reject">إلغاء</button>
        </div>
      `;

      // تعطيل الأزرار لو ليست pending
      if(x.status !== 'pending'){
        d.querySelectorAll('.chip.ok, .chip.no').forEach(b=> b.setAttribute('disabled','true'));
      }

      // نسخ العنوان
      d.querySelector('[data-copy]')?.addEventListener('click', async ()=>{
        const val = String(d.querySelector('[data-copy]').dataset.copy || '');
        try{ await navigator.clipboard.writeText(val); toast('تم نسخ العنوان'); }catch(_){ toast('تعذّر النسخ'); }
      });

      // اعتماد
      d.querySelector('[data-act="approve"]')?.addEventListener('click', async ()=>{
        if(!confirm(`اعتماد طلب ${x.id} للمستخدم ${x.name}؟`)) return;
        d.querySelectorAll('[data-act]').forEach(b=>b.setAttribute('disabled','true'));
        try{
          const wRef    = db.ref(`withdrawals/${x.uid}/${x.id}`);
          const currRef = db.ref(`withdrawals/${x.uid}/current`);
          // تحدیث أثر قبل الحذف (اختياري)
          await wRef.update({ status:'approved', approvedAt: Date.now() });
          // إزالة مؤشر الطلب الحالي إن وُجد
          const curr = (await currRef.get()).val();
          if(curr === x.id) await currRef.set(null);
          // ✅ حذف السجل نهائيًا
          await wRef.remove();
          toast('تم الاعتماد والحذف من القاعدة');
        }catch(e){
          console.error(e); toast('تعذّر الاعتماد'); d.querySelectorAll('[data-act]').forEach(b=>b.removeAttribute('disabled'));
        }
      });

      // رفض + إرجاع المبلغ ثم الحذف
      d.querySelector('[data-act="reject"]')?.addEventListener('click', async ()=>{
        if(!confirm(`رفض طلب ${x.id} وإرجاع ${fmt(x.amount)} USDT إلى ${x.name}؟`)) return;
        d.querySelectorAll('[data-act]').forEach(b=>b.setAttribute('disabled','true'));
        try{
          const userRef = db.ref(`users/${x.uid}`);
          const wRef    = db.ref(`withdrawals/${x.uid}/${x.id}`);
          const currRef = db.ref(`withdrawals/${x.uid}/current`);

          // إرجاع المبلغ
          await userRef.transaction(cur=>{
            if(!cur) return cur;
            const bal = Number(cur.balance||0);
            const nb  = +(bal + Number(x.amount||0)).toFixed(2);
            return { ...cur, balance: nb };
          });

          // أثر قبل الحذف (اختياري)
          await wRef.update({ status:'rejected', rejectedAt: Date.now() });

          // إزالة مؤشر الطلب الحالي إن وُجد
          const curr = (await currRef.get()).val();
          if(curr === x.id) await currRef.set(null);

          // ✅ حذف السجل نهائيًا
          await wRef.remove();

          toast('تم الرفض ورجوع المبلغ والحذف من القاعدة');
        }catch(e){
          console.error(e); toast('تعذّر الرفض'); d.querySelectorAll('[data-act]').forEach(b=>b.removeAttribute('disabled'));
        }
      });

      return d;
    }

    function render(rows){
      const cont = $("#list"), empty=$("#empty");
      cont.innerHTML = '';
      rows.sort((a,b)=> (b.tsISO||'').localeCompare(a.tsISO||''));
      if(!rows.length){ empty.style.display='block'; return; }
      empty.style.display='none';
      rows.forEach(x=> cont.appendChild(rowEl(x)));
    }

    async function fetchAndRender(showToast){
      // نُعيد البناء من snapshot الحالي (مخزّن في lastRows)
      render(lastRows);
      if(showToast) toast('تم التحديث');
    }

    // مستمع لحظي
    setLive(true);
    listRef.on('value', async (snap)=>{
      try{
        const rows=[];
        const promises=[];
        snap.forEach(userNode=>{
          const uid = userNode.key;
          // حضّر الاسم (كاش)
          promises.push(getUserName(uid));
          userNode.forEach(child=>{
            const id = child.key;
            const v  = child.val() || {};
            rows.push(adapt(uid, id, v));
          });
        });
        await Promise.all(promises);
        // حدّث الأسماء بعد الكاش
        lastRows = rows.map(r=> ({...r, name: userCache.get(r.uid) || r.name || '—'}));
        render(lastRows);
      }catch(e){
        console.error(e); setLive(false); toast('تعذّر الاتصال');
      }
    }, _=>{ setLive(false); });

  })();
  </script>
  
  
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
</script>
  
  
  <script>
/* ===== إشعارات سطح المكتب + فحص رسائل كل 5 ثواني ===== */
(function () {
  // لازم Firebase compat يكون مفعّل فوق (أنت بالفعل محمّله في الصفحة)
  if (!window.firebase || !firebase.database) return;

  // طلب صلاحية الإشعارات مرة واحدة
  async function ensureNotifyPermission() {
    try {
      if (!('Notification' in window)) return false;
      if (Notification.permission === 'granted') return true;
      if (Notification.permission === 'denied') return false;
      const perm = await Notification.requestPermission();
      return perm === 'granted';
    } catch (_) { return false; }
  }

  // إظهار إشعار سطح مكتب
  function showDesktop(title, body, data) {
    try {
      if (!('Notification' in window)) return;
      if (Notification.permission !== 'granted') return;
      const n = new Notification(title || 'إشعار', {
        body: body || '',
        icon: '/icon-192.png',    // لو عندك أيقونة ضع مسارها هنا
        badge: '/icon-72.png',    // شارة صغيرة اختيارية
        tag: (data && data.tag) || 'dynex-msg', // لمنع تكرار نفس الإشعار
        renotify: false
      });
      n.onclick = (e) => {
        e.preventDefault();
        window.focus();
        // تقدر تفتح الشيت/صفحة الرسائل هنا لو ودك:
        // document.getElementById('messagesBtn')?.click();
        n.close();
      };
      setTimeout(()=>n.close(), 8000); // يغلق بعد 8 ثواني (اختياري)
    } catch(_) {}
  }

  // صوت خفيف (اختياري)
  let snd = document.getElementById('msgSnd');
  if (!snd) {
    snd = document.createElement('audio');
    snd.id = 'msgSnd';
    snd.preload = 'auto';
    snd.src = 'data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAA'; // بدّلها لو عندك ملف
    document.body.appendChild(snd);
  }

  // UID من الجلسة — للإنبوكس الخاص (إن وجد)
  let UID = null;
  try {
    const s = JSON.parse(localStorage.getItem('dynex_session') || 'null');
    UID = s && s.uid;
  } catch(_) {}

  const db = firebase.database();
  const refPublic  = db.ref('company/messages');
  const refPrivate = UID ? db.ref('user_inbox/' + UID) : null;

  // نخزن آخر مفتاح شُوهد — عشان ما نكرر
  const LS_PUB  = 'notif_last_company';
  const LS_PRIV = 'notif_last_inbox';
  const getSeen = (k)=> localStorage.getItem(k) || '';
  const setSeen = (k,v)=> localStorage.setItem(k, v || '');

  // تحويل push key لأقرب وقت (للترتيب/العرض الاحتياط)
  const PUSH_CHARS = '-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz';
  function pushIdToTime(id){
    if(!id) return 0;
    let ts=0;
    for(let i=0;i<8;i++){ ts = ts*64 + PUSH_CHARS.indexOf(id.charAt(i)); }
    return ts;
  }

  // صياغة عنوان/نص للإشعار من آخر رسالة
  function makeNotifPayload(lastObj){
    const title = (lastObj.title || 'رسالة جديدة').trim();
    const body  = String(lastObj.body || lastObj.text || '').trim();
    return { title, body };
  }

  // فحص مرجع (عام/خاص): يقرأ آخر عنصر، يقارن، ويشغّل إشعار إذا الصفحة بالخلفية
  async function checkLatestOnce(ref, storeKey, tag) {
    try {
      const snap = await ref.limitToLast(1).get();
      if (!snap.exists()) return false;
      let lastKey = '', lastObj = null;
      snap.forEach(ch => { lastKey = ch.key; lastObj = ch.val() || {}; });

      // جديد؟
      const seen = getSeen(storeKey);
      const hasNew = lastKey && lastKey !== seen;

      // تحديث الـ seen فورًا (عشان ما تتكرر الإشعارات) — تقدر تأخره لين تفتح الشيت
      // بس هنا نبغى إشعار مرة وحدة فقط.
      if (hasNew) setSeen(storeKey, lastKey);

      // لو الصفحة بالخلفية + عندنا صلاحية → أعرض إشعار Banner
      if (hasNew && document.hidden) {
        const ok = await ensureNotifyPermission();
        if (ok) {
          const { title, body } = makeNotifPayload(lastObj);
          showDesktop(title, body, { tag });
        }
        // صوت بسيط
        try { snd.currentTime = 0; snd.play().catch(()=>{}); } catch(_) {}
      }

      return hasNew;
    } catch(_) { return false; }
  }

  // فحص دوري كل 5 ثواني
  async function pollAll() {
    try {
      await checkLatestOnce(refPublic, LS_PUB,  'company');
      if (refPrivate) await checkLatestOnce(refPrivate, LS_PRIV, 'inbox');
    } catch(_) {}
  }

  // مستمع لحظي (يشتغل حتى لو ما سوّينا poll)
  refPublic.limitToLast(1).on('value', pollAll);
  if (refPrivate) refPrivate.limitToLast(1).on('value', pollAll);

  // احتياط كل 5 ثواني
  setInterval(pollAll, 5000);

  // اطلب الصلاحية أول ما يحمّل (مرة واحدة فقط)
  ensureNotifyPermission();

  // لو عندك زر رسائل/نقطة… خلّي فتح الشيت يوقف النقطة/الهزّة الخ
  // (اختياري، يشتغل مع كودك الحالي)
  document.getElementById('messagesBtn')?.addEventListener('click', ()=>{
    // لما تفتح الرسائل، اعتبر آخر واحد مقروء
    refPublic.limitToLast(1).get().then(s=>s.forEach(ch=>setSeen(LS_PUB, ch.key)));
    if (refPrivate) refPrivate.limitToLast(1).get().then(s=>s.forEach(ch=>setSeen(LS_PRIV, ch.key)));
  });
})();
</script>
  
</body>
</html>