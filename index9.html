<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynex – إدارة الرصيد</title>

  <!-- خطوط وأيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">

  <style>
    :root{
      --gray:#C7C7C7;      /* الرمادي الرسمي */
      --accent:#F36523;    /* البرتقالي الرسمي */
      --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --top:54px; --radius:16px; --top-icon:#1E3A8A;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font-family:"Cairo", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;color:var(--ink);background:#fff;min-height:100dvh;overflow-x:hidden}

    /* ===== الشريط العلوي ===== */
    .appbar{position:fixed;top:0;inset-inline:0;height:var(--top);z-index:40;background:var(--gray);
      display:flex;align-items:center;justify-content:space-between;padding:4px 10px;box-shadow:0 1px 0 #bfbfbf}
    .accent-line{height:3px;background:var(--accent)}
    .btn{width:40px;height:40px;border-radius:12px;background:#fff;border:1px solid #d3d3d3;display:grid;place-items:center;cursor:pointer;color:var(--top-icon);position:relative;overflow:hidden}
    .btn.orange{color:var(--accent)}
    .ms{font-family:'Material Symbols Rounded';font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 24;line-height:1}

    /* ===== الحاوية ===== */
    .page{width:min(520px,92vw);margin:0 auto;display:flex;flex-direction:column;gap:12px;padding:16px 0 90px;padding-top:calc(var(--top) + 16px);}

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 8px 18px rgba(0,0,0,.06);padding:12px}

    h2{margin:6px 10px 10px;font-size:18px}
    .row{display:flex;align-items:center;gap:10px}
    .field{display:flex;align-items:center;gap:8px;border:1px solid #e6e7ea;border-radius:12px;background:#f9fafb;padding:10px}
    .field input{flex:1;border:none;background:transparent;outline:none;font-family:inherit}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-weight:800;font-size:12px}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid4{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:420px){ .grid4{grid-template-columns:repeat(4,1fr);} }

    .kpi{display:grid;gap:4px;border:1px solid #ececec;border-radius:14px;background:#f7f7f8;padding:10px;text-align:center}
    .kpi .hd{font-size:12px;color:#6b7280;font-weight:800}
    .kpi .val{font-size:18px;font-weight:900}

    .opbtn{padding:12px;border-radius:12px;border:1px solid #e3e3e3;background:#fff;cursor:pointer;font-weight:900}
    .opbtn.orange{background:var(--accent);border-color:var(--accent);color:#000}
    .opbtn.blue{background:#fff;border-color:#e3e3e3;color:#000}

    .list{display:grid;gap:6px;margin-top:8px}
    .item{display:flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:10px;font-weight:700}
    .item .sep{opacity:.5}

    /* Ripple + Toast */
    .ripple{position:absolute;border-radius:50%;transform:scale(0);background:rgba(0,0,0,.18);animation:ripple .6s linear;pointer-events:none}
    @keyframes ripple{to{transform:scale(3);opacity:0}}
    .ripple-container{position:relative;overflow:hidden}

    .toast{position:fixed;bottom:78px;left:50%;transform:translateX(-50%) scale(.96);background:rgba(17,17,17,.92);color:#fff;
      padding:8px 12px;border-radius:10px;font-weight:800;font-size:12px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:70}
    .toast.show{opacity:1;transform:translateX(-50%) scale(1)}
  </style>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#BBCF38">
  
</head>
<body>

  <!-- الشريط العلوي -->
  <header class="appbar">
    <button class="btn ripple-container orange" id="backBtn" title="رجوع"><span class="ms">arrow_back_ios_new</span></button>
    <div style="display:flex;gap:8px;align-items:center">
      <span class="pill"><span class="ms">admin_panel_settings</span>لوحة الإدارة</span>
    </div>
  </header>
  <div class="accent-line"></div>

  <main class="page">

    <!-- البحث عن مستخدم -->
    <section class="card">
      <h2>البحث عن مستخدم</h2>
      <div class="row" style="gap:8px">
        <div class="field" style="flex:1">
          <input id="q" placeholder="أدخل الاسم الكامل أو ID يبدأ بـ 99">
          <button class="btn ripple-container" id="doSearch" title="بحث"><span class="ms">search</span></button>
        </div>
        <div id="live" class="pill" title="حالة الاتصال"><span class="ms">online_prediction</span><span>متصل</span></div>
      </div>
    </section>

    <!-- بيانات المستخدم المختار -->
    <section class="card" id="userCard" style="display:none">
      <h2>بيانات المستخدم</h2>
      <div class="grid2">
        <div class="kpi">
          <div class="hd">الاسم</div>
          <div class="val" id="uName">—</div>
        </div>
        <div class="kpi">
          <div class="hd">ID</div>
          <div class="val" id="uId">—</div>
        </div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="kpi">
          <div class="hd">الرصيد</div>
          <div class="val" id="uBal">0.00</div>
        </div>
        <div class="kpi">
          <div class="hd">العقد المقفل</div>
          <div class="val" id="uLocked">0.00</div>
        </div>
      </div>
    </section>

    <!-- العمليات -->
    <section class="card" id="opsCard" style="display:none">
      <h2>تنفيذ عملية</h2>
      <div class="field">
        <input id="amount" dir="ltr" inputmode="decimal" placeholder="المبلغ (مثال: 100 أو 100.50)">
        <button class="btn ripple-container" id="clearAmt" title="مسح"><span class="ms">backspace</span></button>
      </div>

      <div class="grid4" style="margin-top:10px">
        <button class="opbtn orange ripple-container" id="btnDepBal">إيداع للرصيد</button>
        <button class="opbtn blue ripple-container"   id="btnWdrBal">سحب من الرصيد</button>
        <button class="opbtn orange ripple-container" id="btnToLocked">إلى العقد المقفل</button>
        <button class="opbtn blue ripple-container"   id="btnFromLocked">من العقد المقفل</button>
      </div>
    </section>

    <!-- آخر العمليات (اختياري) -->
    <section class="card" id="logCard" style="display:none">
      <h2>آخر العمليات</h2>
      <div class="list" id="logList"></div>
    </section>

  </main>

  <div id="toast" class="toast"></div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // ===== تهيئة Firebase بمشروعك =====
    const firebaseConfig = {
      apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",
      authDomain: "dynex-f4486.firebaseapp.com",
      databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",
      projectId: "dynex-f4486",
      storageBucket: "dynex-f4486.firebasestorage.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== أدوات واجهة عامة =====
    const $ = s => document.querySelector(s);
    function toast(msg){ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1400); }
    function ripple(ev){
      const t = ev.currentTarget || ev.target.closest('.ripple-container'); if(!t) return;
      const r = document.createElement('span'); const d=Math.max(t.clientWidth,t.clientHeight); const rect=t.getBoundingClientRect();
      r.className='ripple'; r.style.width=r.style.height=d+'px'; r.style.left=(ev.clientX-rect.left-d/2)+'px'; r.style.top=(ev.clientY-rect.top-d/2)+'px';
      const old=t.querySelector('.ripple'); if(old) old.remove(); t.appendChild(r); setTimeout(()=>r.remove(),600);
    }
    document.querySelectorAll('.ripple-container').forEach(el=>el.addEventListener('click', ripple));
    $("#backBtn").onclick = ()=>{ if(history.length>1) history.back(); else window.location.replace('index1.html'); };

    // حالة الاتصال (اختياري)
    const live = $("#live");
    db.ref(".info/connected").on("value", s=>{
      const ok = !!s.val();
      live.querySelector('.ms').textContent = ok ? 'online_prediction' : 'report_gmailerrorred';
      live.lastChild.textContent = ok ? 'متصل' : 'غير متصل';
      live.style.background = ok ? '#fff' : '#fff1f1';
      live.style.borderColor = ok ? '#e5e7eb' : '#ffe4e6';
    });

    // ===== منطق البحث =====
    let currentKey = null;   // مفتاح صف المستخدم داخل users
    let currentUser = null;  // بيانات المستخدم الحالية

    // ✅ دالة بحث محسّنة: UID مباشر، accountId كنص/رقم، والاسم
    async function findUser(term){
      const t = String(term||'').trim();
      if(!t) return null;

      // 1) UID مباشر users/{uid}
      try{
        const s = await firebase.database().ref('users/'+t).once('value');
        if (s.exists()) return { key: t, user: s.val() };
      }catch(_){}

      // 2) accountId (نجرّب تساوي نص ثم رقم)
      if (/^99\d{7}$/.test(t) || /^\d+$/.test(t)) {
        try{
          // كنص
          let s = await firebase.database().ref('users').orderByChild('accountId').equalTo(t).once('value');
          if (s.exists()){
            const obj = s.val(); const key = Object.keys(obj)[0];
            return { key, user: obj[key] };
          }
          // كرقم
          const tNum = Number(t);
          s = await firebase.database().ref('users').orderByChild('accountId').equalTo(tNum).once('value');
          if (s.exists()){
            const obj = s.val(); const key = Object.keys(obj)[0];
            return { key, user: obj[key] };
          }
        }catch(e){
          console.error('accountId query error:', e);
          throw e;
        }
      }

      // 3) الاسم الكامل (تطابق تام)
      try{
        const s = await firebase.database().ref('users').orderByChild('name').equalTo(t).once('value');
        if (s.exists()){
          const obj = s.val(); const key = Object.keys(obj)[0];
          return { key, user: obj[key] };
        }
      }catch(e){
        console.error('name query error:', e);
        throw e;
      }

      return null;
    }

    function fmt2(n){ return Number(n||0).toFixed(2); }

    function renderUser(u){
      $("#uName").textContent = u.name || '—';
      $("#uId").textContent   = u.accountId || '—';
      $("#uBal").textContent  = fmt2(u.balance || 0);
      $("#uLocked").textContent = fmt2(u.lockedAmount || 0);
      $("#userCard").style.display = '';
      $("#opsCard").style.display = '';
      $("#logCard").style.display = '';
    }

    async function loadLog(){
      if(!currentKey) return;
      const ul = $("#logList");
      ul.innerHTML = '';
      const snap = await db.ref('adminOps/'+currentKey).limitToLast(10).get();
      if(!snap.exists()) return;

      const rows = Object.values(snap.val()||{}).sort((a,b)=>Number(b.at||0)-Number(a.at||0));
      rows.forEach(x=>{
        const d = document.createElement('div');
        d.className = 'item';
        d.innerHTML = `
          <span>${x.op||'-'}</span>
          <span class="sep">·</span>
          <span>${fmt2(x.amount||0)}</span>
          <span class="sep">·</span>
          <span>${ new Date(x.at||Date.now()).toLocaleString() }</span>
        `;
        ul.appendChild(d);
      });
    }

    $("#doSearch").onclick = async (e)=>{
      ripple(e);
      const term = $("#q").value.trim();
      if(!term){ toast('أدخل الاسم أو ID'); return; }
      $("#doSearch").disabled = true;
      try{
        const result = await findUser(term);
        if(!result){ toast('المستخدم غير موجود'); return; }
        currentKey = result.key;
        currentUser= result.user;
        renderUser(currentUser);
        loadLog();
      }catch(err){
        console.error(err);
        if (err && err.code === 'PERMISSION_DENIED') {
          toast('صلاحيات القراءة مرفوضة (Rules)');
        } else {
          toast('تعذّر البحث');
        }
      }finally{
        $("#doSearch").disabled = false;
      }
    };
    $("#q").addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); $("#doSearch").click(); } });

    // مسح المبلغ
    $("#clearAmt").onclick = ripple;
    $("#clearAmt").addEventListener('click', ()=> $("#amount").value='');

    // ===== تنفيذ العمليات بالـ transaction =====
    async function doOp(kind){
      if(!currentKey){ toast('اجلب المستخدم أولاً'); return; }

      const raw = String($("#amount").value||'').trim().replace(',', '.');
      const val = parseFloat(raw);
      if (!val || val<=0){ toast('أدخل مبلغ صحيح'); return; }

      const userRef = db.ref('users/'+currentKey);

      // فحص سريع قبل المعاملة
      const snap0 = await userRef.get();
      if(!snap0.exists()){ toast('المستخدم غير موجود'); return; }
      const u0 = snap0.val() || {};
      let bal0 = Number(u0.balance||0);
      let lock0= Number(u0.lockedAmount||0);

      if (kind==='withdraw_balance' || kind==='to_locked'){
        if (bal0 < val){ toast('رصيد غير كافٍ'); return; }
      }
      if (kind==='from_locked'){
        if (lock0 < val){ toast('المبلغ المقفل غير كافٍ'); return; }
      }

      const result = await userRef.transaction(user=>{
        if(!user) return user;
        let bal = Number(user.balance||0);
        let lock= Number(user.lockedAmount||0);

        if (kind==='deposit_balance'){
          bal += val;
        }else if (kind==='withdraw_balance'){
          if (bal < val) return;
          bal -= val;
        }else if (kind==='to_locked'){
          if (bal < val) return;
          bal -= val; lock += val;
        }else if (kind==='from_locked'){
          if (lock < val) return;
          lock -= val; bal += val;
        }else{
          return;
        }

        user.balance = Number(bal.toFixed(2));
        user.lockedAmount = Number(lock.toFixed(2));
        user.updatedAt = firebase.database.ServerValue.TIMESTAMP;
        return user;
      });

      if(!result.committed){
        toast('تعذّر التنفيذ، حاول مرة أخرى');
        return;
      }

      const u1 = result.snapshot.val() || {};
      $("#uBal").textContent    = fmt2(u1.balance||0);
      $("#uLocked").textContent = fmt2(u1.lockedAmount||0);

      await db.ref('adminOps/'+currentKey).push({
        op: kind,
        amount: Number(val.toFixed(2)),
        before: { balance: Number(bal0.toFixed ? bal0.toFixed(2) : bal0), locked: Number(lock0.toFixed ? lock0.toFixed(2) : lock0) },
        after:  { balance: Number(u1.balance||0), locked: Number(u1.lockedAmount||0) },
        at: firebase.database.ServerValue.TIMESTAMP
      });

      toast('تم التنفيذ');
      $("#amount").value='';
      loadLog();
    }

    // ربط الأزرار
    $("#btnDepBal").onclick    = (e)=>{ ripple(e); doOp('deposit_balance'); };
    $("#btnWdrBal").onclick    = (e)=>{ ripple(e); doOp('withdraw_balance'); };
    $("#btnToLocked").onclick  = (e)=>{ ripple(e); doOp('to_locked'); };
    $("#btnFromLocked").onclick= (e)=>{ ripple(e); doOp('from_locked'); };

  </script>
  
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(reg => console.log("✔ Service Worker registered"))
        .catch(err => console.error("❌ Service Worker failed:", err));
    }
  </script>
  
</body>
</html>