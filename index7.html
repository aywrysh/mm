

<!DOCTYPE html>  <html lang="ar" dir="rtl">    <head>    
  <meta charset="UTF-8" />    
  <meta name="viewport" content="width=device-width, initial-scale=1" />    
  <title>إرسال رسالة | نظام الشركة</title>    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">    
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0" rel="stylesheet">    <style>    
    :root{ --accent:#BBCF38; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb; --card:#fff; --bg:#f6f7f9; --radius:14px; --top:60px; }    
    *{box-sizing:border-box}    
    body{margin:0;font-family:"Cairo",system-ui,Segoe UI,Roboto,Arial;color:var(--ink);background:var(--bg)}    
    .topbar{position:fixed;inset-inline:0;top:0;height:var(--top);background:var(--card);border-bottom:1px solid var(--line);    
      display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:10}    
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}    
    .brand .dot{width:14px;height:14px;border-radius:50%;background:var(--accent)}    
    .btn{display:grid;place-items:center;width:40px;height:40px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}    
    .wrap{min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:calc(var(--top) + 24px) 16px 24px}    
    .card{width:min(520px,92vw);background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 10px 24px rgba(0,0,0,.06);padding:18px}    
    h1{margin:0 0 6px;font-size:22px}    
    .field{display:grid;gap:8px;margin:10px 0}    
    .label{font-weight:900;font-size:13px}    
    .input,.area{padding:12px;border:1px solid var(--line);border-radius:12px;background:#fafafa;font-weight:700;width:100%}    
    .area{min-height:140px;resize:vertical}    
    .row{display:flex;gap:10px;flex-wrap:wrap}    
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;font-weight:900;font-size:12px}    
    .muted{color:var(--muted);font-size:12px}    
    .actions{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}    
    .btn-solid{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:900;cursor:pointer}    
    .btn-solid.primary{background:var(--accent);border-color:var(--accent);color:#111}    
    .toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) scale(.96);background:rgba(17,17,17,.92);color:#fff;padding:8px 12px;border-radius:10px;font-weight:800;font-size:12px;opacity:0;pointer-events:none;transition:.25s;z-index:30}    
    .toast.show{opacity:1;transform:translateX(-50%) scale(1)}    
  </style>    <link rel="manifest" href="manifest.json">    
  <meta name="theme-color" content="#BBCF38">    
</head>    
<body>    
  <header class="topbar">    
    <div class="brand"><span class="dot"></span><span>نظام الشركة</span></div>    
    <button class="btn" id="backBtn" title="رجوع"><span class="ms">arrow_back_ios_new</span></button>    
  </header>    <main class="wrap">    
    <section class="card">    
      <h1>إرسال رسالة</h1>  <!-- وضع الإرسال -->    
  <div class="field">    
    <label class="label">الوضع</label>    
    <div class="row">    
      <label class="chip"><input type="radio" name="mode" value="all" checked style="accent-color:#BBCF38"> جماعية للجميع</label>    
      <label class="chip"><input type="radio" name="mode" value="direct" style="accent-color:#BBCF38"> مخصّصة لمستخدم</label>    
    </div>    
    <div class="muted">اختر “مخصّصة” لو تحب ترسل لشخص محدد بالـ UID / AccountID / Username.</div>    
  </div>      <!-- المستلم (تظهر فقط عند مخصّصة) -->      <div class="field" id="rcpField" style="display:none">    
    <label class="label">المستلم (UID أو AccountID أو Username)</label>    
    <input id="rcp" class="input" type="text" placeholder="مثال: 991234567 أو U7nZaQ1 أو user123" dir="ltr">    
    <div class="muted" id="rcpHint">سيتم البحث تلقائيًا وتحديد المستخدم الصحيح.</div>    
  </div>      <div class="field">    
    <label class="label">العنوان</label>    
    <input id="title" class="input" type="text" placeholder="عنوان مختصر (اختياري)">    
  </div>      <div class="field">    
    <label class="label">المحتوى</label>    
    <textarea id="body" class="area" placeholder="نص الرسالة"></textarea>    
  </div>      <div class="actions">    
    <button class="btn-solid" id="clearBtn">مسح</button>    
    <button class="btn-solid primary" id="sendBtn">إرسال</button>    
  </div>    
</section>    </main>    <div id="toast" class="toast"></div>    <script type="module">    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";    
    import { getDatabase, ref, push, set, serverTimestamp, get, child, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";    const firebaseConfig = {    
  apiKey: "AIzaSyBr3mtTHa_nJajn9H5N1V5sWNHIHY8RU8g",    
  authDomain: "dynex-f4486.firebaseapp.com",    
  databaseURL: "https://dynex-f4486-default-rtdb.firebaseio.com",    
  projectId: "dynex-f4486",    
  storageBucket: "dynex-f4486.firebasestorage.app"    
};    

const app = initializeApp(firebaseConfig);    
const db  = getDatabase(app);    

const $ = s=>document.querySelector(s);    
const toastBox = $("#toast");    
function toast(m){ toastBox.textContent=m; toastBox.classList.add('show'); setTimeout(()=>toastBox.classList.remove('show'),1500); }    

// رجوع    
$("#backBtn").addEventListener('click', ()=>{ if(history.length>1) history.back(); else window.location.replace('index1.html'); });    

// تبديل وضع الإرسال    
const modeRadios = document.querySelectorAll('input[name="mode"]');    
const rcpField = $("#rcpField");    
modeRadios.forEach(r=>{    
  r.addEventListener('change', ()=>{    
    const mode = document.querySelector('input[name="mode"]:checked')?.value || 'all';    
    rcpField.style.display = (mode === 'direct') ? '' : 'none';    
  });    
});    

// مسح    
$("#clearBtn").addEventListener('click', ()=>{    
  $("#title").value=''; $("#body").value='';    
  $("#rcp").value='';    
});    

// ====== البحث عن مستخدم (UID أو AccountID أو Username) ======    
// يرجع: { uid, ...user }    
async function findUserByAnyKey(keyRaw){    
  const key = (keyRaw||'').trim();    
  if(!key) return null;    

  // 1) إن كان UID مباشرًا (مفتاح تحت users/{uid})    
  try{    
    const snap = await get(ref(db, 'users/' + key));    
    if (snap.exists()) return { uid:key, ...(snap.val()||{}) };    
  }catch(_){}    

  // 2) accountId    
  try{    
    const q = query(ref(db,'users'), orderByChild('accountId'), equalTo(key));    
    const s = await get(q);    
    if (s.exists()){    
      // أول عنصر    
      let out=null;    
      s.forEach(ch=>{ if(!out) out = { uid: ch.key, ...(ch.val()||{}) }; });    
      if(out) return out;    
    }    
  }catch(_){}    

  // 3) username    
  try{    
    const q = query(ref(db,'users'), orderByChild('username'), equalTo(key));    
    const s = await get(q);    
    if (s.exists()){    
      let out=null;    
      s.forEach(ch=>{ if(!out) out = { uid: ch.key, ...(ch.val()||{}) }; });    
      if(out) return out;    
    }    
  }catch(_){}    

  // 4) name (احتمالي)    
  try{    
    const q = query(ref(db,'users'), orderByChild('name'), equalTo(key));    
    const s = await get(q);    
    if (s.exists()){    
      let out=null;    
      s.forEach(ch=>{ if(!out) out = { uid: ch.key, ...(ch.val()||{}) }; });    
      if(out) return out;    
    }    
  }catch(_){}    

  // 5) REST fallback (لو صلاحيات القراءة مسموحة)    
  try{    
    const res = await fetch(firebaseConfig.databaseURL + "/users.json");    
    const all = await res.json() || {};    
    for(const k in all){    
      const u = all[k] || {};    
      if (k===key || String(u.accountId||'')===key || String(u.username||'')===key || String(u.name||'')===key){    
        return { uid:k, ...u };    
      }    
    }    
  }catch(_){}    

  return null;    
}    

// ====== إرسال ======    
$("#sendBtn").addEventListener('click', async ()=>{    
  const mode  = document.querySelector('input[name="mode"]:checked')?.value || 'all';    
  const title = ($("#title").value||'').trim();    
  const body  = ($("#body").value||'').trim();    

  if(!body){ toast('اكتب محتوى الرسالة'); return; }    

  const btn = $("#sendBtn"); const prev = btn.textContent; btn.disabled = true; btn.textContent = 'جارٍ الإرسال...';    

  try{    
    if(mode === 'all'){    
      // بث للجميع    
      const p = push(ref(db, 'company/messages'));    
      await set(p, {    
        title: title || 'إشعار',    
        body,    
        createdAt: serverTimestamp()    
      });    
      toast('تم الإرسال جماعيًا');    
    }else{    
      // مخصّصة    
      const raw = ($("#rcp").value||'').trim();    
      if(!raw){ toast('اكتب هوية المستلم'); return; }    

      const user = await findUserByAnyKey(raw);    
      if(!user || !user.uid){ toast('المستلم غير موجود'); return; }    

      // نرسل في صندوقه الخاص    
      const p = push(ref(db, `user_inbox/${user.uid}`));    
      await set(p, {    
        title: title || 'رسالة من الشركة',    
        body,    
        createdAt: serverTimestamp()    
      });    

      toast(`تم الإرسال للمستخدم: ${user.username || user.name || user.accountId || user.uid}`);    
    }    

    // تنظيف النص فقط    
    $("#body").value='';    
  }catch(e){    
    console.error(e);    
    toast('فشل الإرسال');    
  }finally{    
    btn.disabled=false; btn.textContent=prev;    
  }    
});

  </script> 
   <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(reg => console.log("✔ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker failed:", err));
  }
</script>

</body>
</html>